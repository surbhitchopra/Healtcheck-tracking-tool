



{% extends 'base.html' %}

{% block title %}Customer Dashboard - Health Check Overview{% endblock %}

{% block extra_head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    body {
        background: #f8fafc;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        color: #1e293b;
        line-height: 1.6;
    }
    
    .dashboard-container {
        min-height: 100vh;
        padding: 8px;
        max-width: 1400px;
        margin: 0 auto;
        background: transparent;
        overflow-x: auto;
        overflow-y: visible;
    }
    
    /* HEADER - COMPACT */
    .dashboard-header {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
        border-radius: 6px;
        padding: 4px 8px;
        margin-bottom: 1px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.06), 0 2px 6px rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(59, 130, 246, 0.2);
        position: relative;
        backdrop-filter: blur(20px);
    }
    
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #34d399 100%);
        border-radius: 12px 12px 0 0;
        opacity: 0.9;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .header-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .header-title h1 {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e40af;
        margin: 0;
        line-height: 1.1;
        letter-spacing: -0.025em;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .header-subtitle {
        color: #64748b;
        font-size: 0.7rem;
        margin-top: 2px;
        font-weight: 400;
    }
    
    .live-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .live-dot {
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .header-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .refresh-btn, .export-btn, .back-btn {
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.65rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 3px;
        text-decoration: none;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(8px);
        text-transform: uppercase;
        letter-spacing: 0.02em;
        min-height: 24px;
        white-space: nowrap;
    }
    
    .refresh-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 3px 10px rgba(59, 130, 246, 0.3), 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .refresh-btn:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .export-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 3px 10px rgba(16, 185, 129, 0.3), 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .export-btn:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4), 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .refresh-btn:active, .export-btn:active, .back-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .refresh-btn:active {
        box-shadow: 0 1px 3px rgba(59, 130, 246, 0.4);
    }
    
    .export-btn:active {
        box-shadow: 0 1px 3px rgba(16, 185, 129, 0.4);
    }
    
    .back-btn:active {
        box-shadow: 0 1px 3px rgba(107, 114, 128, 0.4);
    }
    
    .back-btn {
        background: rgba(248, 250, 252, 0.9);
        color: #475569;
        box-shadow: 0 2px 8px rgba(107, 114, 128, 0.15), 0 1px 3px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
    }
    
    .back-btn:hover {
        background: rgba(241, 245, 249, 0.95);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.2), 0 2px 6px rgba(0, 0, 0, 0.08);
        text-decoration: none;
        color: #334155;
    }
    
    /* HEADER STATS CARDS - COMPACT */
    .header-stats-grid {
        display: flex;
        gap: 6px;
        align-items: center;
        margin-right: 8px;
    }
    
    .header-stat-card {
        display: flex;
        align-items: center;
        gap: 3px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid rgba(59, 130, 246, 0.15);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.04), 0 1px 4px rgba(0, 0, 0, 0.02);
        min-width: 70px;
        min-height: 24px;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
    }
    
    .header-stat-icon {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        flex-shrink: 0;
    }
    
    .header-stat-info {
        display: flex;
        flex-direction: column;
        gap: 0;
    }
    
    .header-stat-title {
        font-size: 0.55rem;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        line-height: 1;
    }
    
    .header-stat-value {
        font-size: 0.75rem;
        font-weight: 700;
        color: #1f2937;
        line-height: 1;
    }
    
    .header-stat-card:hover {
        transform: translateY(-2px);
        background: linear-gradient(145deg, rgba(59, 130, 246, 0.02), rgba(96, 165, 250, 0.02));
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.08), 0 4px 12px rgba(0, 0, 0, 0.06);
        border-color: rgba(59, 130, 246, 0.25);
    }
    
    .header-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    /* DATE FILTER SECTION */
    .filter-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 2px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .filter-content {
        display: flex;
        align-items: end;
        gap: 1px;
        flex: 1;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .filter-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #374151;
    }

    .filter-input {
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        min-width: 130px;
    }

    .filter-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    .filter-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.55rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        align-self: end;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        min-width: 80px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .filter-btn:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4), 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .filter-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 4px rgba(59, 130, 246, 0.3);
    }
    
    /* STATS FLEXBOX - More Responsive */
    .stats-grid {
        display: flex;
        justify-content: space-between;
        align-items: stretch;
        gap: 8px;
        margin-bottom: 12px;
        width: 100%;
        flex-wrap: wrap;
        min-height: 120px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        padding: 16px 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: visible;
        flex: 1;
        min-width: 200px;
        max-width: none;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 100px;
    }
    
    .stat-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.18), 0 4px 16px rgba(0, 0, 0, 0.08);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .stat-card:hover::before {
        left: 100%;
    }
    
    .stat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    
    .stat-icon {
        width: 14px;
        height: 14px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .stat-title {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 600;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: #1f2937;
        margin: 8px 0;
        line-height: 1;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        position: relative;
        z-index: 1;
    }
    
    .stat-change {
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 4px;
    }
    
    .stat-change.positive {
        color: #10b981;
    }
    
    .stat-change.neutral {
        color: #6b7280;
    }
    
    /* Circular Progress Indicators */
    .stat-visual {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 16px 0;
        position: relative;
    }
    
    .circular-progress {
        position: relative;
        width: 12px;
        height: 12px;
    }
    
    .circular-progress svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }
    
    .progress-bg {
        fill: none;
        stroke: rgba(0, 0, 0, 0.1);
        stroke-width: 1.5;
    }
    
    .progress-fill {
        fill: none;
        stroke-width: 1.5;
        stroke-linecap: round;
        transition: stroke-dasharray 1.5s ease-in-out;
    }
    
    .progress-customers {
        stroke: url(#gradient-customers);
    }
    
    .progress-runs {
        stroke: url(#gradient-runs);
    }
    
    .progress-trackers {
        stroke: url(#gradient-trackers);
    }
    
    .progress-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.95rem;
        font-weight: 700;
        color: #1f2937;
    }
    
    /* Animated dots decoration */
    .stat-decoration {
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
    }
    
    .floating-dots {
        position: absolute;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        opacity: 0.3;
        animation: floatDots 3s ease-in-out infinite;
    }
    
    .dot-1 {
        top: 20%;
        right: 15%;
        background: #cbd5e1;
        animation-delay: 0s;
    }
    
    .dot-2 {
        top: 60%;
        right: 25%;
        background: #10b981;
        animation-delay: 0.5s;
    }
    
    .dot-3 {
        top: 40%;
        right: 8%;
        background: #f59e0b;
        animation-delay: 1s;
    }
    
    @keyframes floatDots {
        0%, 100% {
            transform: translateY(0px) scale(1);
            opacity: 0.3;
        }
        50% {
            transform: translateY(-8px) scale(1.2);
            opacity: 0.6;
        }
    }
    
    /* Professional stat card layout */
    .stat-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    
    .stat-main {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .stat-info {
        flex: 1;
    }
    
    /* PROFESSIONAL TRACKING GRAPH */
    .tracking-graph-container {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
        backdrop-filter: blur(24px);
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 1px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.4);
        position: relative;
        overflow: visible;
        transition: all 0.3s ease;
        width: 100%;
        min-height: 80px;
    }
    
    .tracking-graph-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #e2e8f0 0%, #cbd5e1 50%, #f1f5f9 100%);
        border-radius: 16px 16px 0 0;
        opacity: 0.8;
    }
    
    .tracking-graph-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12), 
                    0 8px 16px rgba(0, 0, 0, 0.07);
    }
    
    .tracking-graph-title {
        font-size: 1.4rem;
        font-weight: 800;
        background: linear-gradient(135deg, #1e293b 0%, #64748b 60%, #94a3b8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0 0 20px 0;
        letter-spacing: -0.01em;
        line-height: 1.2;
        position: relative;
        z-index: 1;
    }
    
    .tracking-graph {
        display: flex;
        align-items: end;
        gap: 1px;
        height: 50px;
        padding: 4px 8px;
        background: linear-gradient(to top, rgba(102, 126, 234, 0.03) 0%, transparent 40%);
        border-radius: 6px;
        position: relative;
        z-index: 1;
        overflow-x: auto;
        overflow-y: hidden;
    }
    
    /* Dynamic sizing for tracking graphs based on content */
    .tracking-graph-container.dynamic {
        min-width: 400px;
        flex: none;
    }
    
    .tracking-graph-container.compact {
        min-width: 300px;
        max-width: 600px;
    }
    
    .tracking-graph-container.expanded {
        min-width: 800px;
        max-width: none;
    }
    
    .tracking-graph::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
    }
    
    .graph-bar {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        min-width: 70px;
        position: relative;
    }
    
    .bar {
        width: 50%;
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        border-radius: 8px 8px 4px 4px;
        min-height: 6px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        box-shadow: 0 4px 12px rgba(203, 213, 225, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
        cursor: pointer;
    }
    
    .bar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.3) 100%);
        border-radius: 8px 8px 0 0;
    }
    
    .bar:hover {
        background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
        transform: translateY(-4px) scaleY(1.08) scaleX(1.1);
        box-shadow: 0 8px 20px rgba(148, 163, 184, 0.4),
                    0 4px 8px rgba(148, 163, 184, 0.2);
    }
    
    .bar-value {
        position: absolute;
        top: -28px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.8rem;
        font-weight: 700;
        color: #1e293b;
        opacity: 0;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
        padding: 2px 6px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .bar:hover .bar-value {
        opacity: 1;
        transform: translateX(-50%) translateY(-4px);
    }
    
    .month-label {
        margin-top: 12px;
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 600;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        transition: color 0.3s ease;
    }
    
    .graph-bar:hover .month-label {
        color: #4f46e5;
        font-weight: 700;
    }
    
    /* PROFESSIONAL CHART LOADING */
    .tracking-graph .loading {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
        color: #64748b;
        font-weight: 500;
    }
    
    .tracking-graph .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid rgba(203, 213, 225, 0.1);
        border-radius: 50%;
        border-top: 3px solid #cbd5e1;
        border-right: 3px solid #94a3b8;
        animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
        box-shadow: 0 0 20px rgba(203, 213, 225, 0.3);
    }
    
    /* PROFESSIONAL CHART ANIMATIONS */
    @keyframes chartSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .tracking-graph-container {
        animation: chartSlideUp 0.8s ease-out;
    }
    
    .bar {
        animation: chartSlideUp 0.6s ease-out;
        animation-fill-mode: both;
    }
    
    .graph-bar:nth-child(1) .bar { animation-delay: 0.1s; }
    .graph-bar:nth-child(2) .bar { animation-delay: 0.2s; }
    .graph-bar:nth-child(3) .bar { animation-delay: 0.3s; }
    .graph-bar:nth-child(4) .bar { animation-delay: 0.4s; }
    .graph-bar:nth-child(5) .bar { animation-delay: 0.5s; }
    .graph-bar:nth-child(6) .bar { animation-delay: 0.6s; }
    
    /* CUSTOMER OVERVIEW */
    .customer-section {
        margin-bottom: 2px;
    }
    
    .section-header {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
        backdrop-filter: blur(20px);
        border-radius: 6px 6px 0 0;
        padding: 3px 8px;
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-bottom: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .section-header-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .customer-filter-section {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
        border-radius: 6px;
        border: 1px solid rgba(59, 130, 246, 0.2);
        backdrop-filter: blur(20px);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.04);
    }
    
    .customer-filter-section .filter-group {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 4px;
        margin: 0;
    }
    
    .customer-filter-section .filter-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        margin: 0;
        white-space: nowrap;
        min-width: auto;
    }
    
    .customer-filter-section .filter-input {
        padding: 4px 8px;
        border: 1px solid #e5e7eb;
        border-radius: 5px;
        font-size: 0.8rem;
        min-width: 110px;
        max-width: 130px;
        transition: all 0.2s ease;
    }
    
    .customer-filter-section .filter-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    .filter-divider {
        width: 1px;
        height: 20px;
        background: rgba(0, 0, 0, 0.1);
        margin: 0 4px;
    }
    
    .customer-filter-section .filter-btn,
    .customer-filter-section .download-btn {
        padding: 5px 8px;
        border: none;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.6rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        height: 26px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        white-space: nowrap;
        min-width: 55px;
    }
    
    .customer-filter-section .filter-btn {
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        box-shadow: 0 3px 8px rgba(59, 130, 246, 0.3), 0 1px 4px rgba(59, 130, 246, 0.2);
    }
    
    .customer-filter-section .download-btn {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        color: white;
        box-shadow: 0 1px 4px rgba(5, 150, 105, 0.3);
    }
    
    .customer-filter-section .filter-btn:hover {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25), 0 3px 10px rgba(59, 130, 246, 0.15);
    }
    
    .customer-filter-section .download-btn:hover {
        background: linear-gradient(135deg, #047857 0%, #065f46 100%);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(5, 150, 105, 0.4);
    }
    
    .customer-filter-section .filter-btn:active,
    .customer-filter-section .download-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .section-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #34d399 100%);
        opacity: 0.8;
    }
    
    .section-title {
        font-size: 1rem;
        font-weight: 700;
        color: #1e40af;
        margin: 0;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .customer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 0;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
        backdrop-filter: blur(20px);
        border-radius: 0 0 16px 16px;
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-top: none;
        max-height: 500px;
        overflow-y: auto;
        overflow-x: visible;
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.08);
        width: 100%;
        position: relative;
        z-index: 1;
    }
    
    .customer-card {
        padding: 20px;
        border-right: 1px solid rgba(0, 0, 0, 0.05);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        transition: background-color 0.3s ease;
    }
    
    .customer-card:hover {
        background: linear-gradient(145deg, rgba(59, 130, 246, 0.02), rgba(96, 165, 250, 0.02));
        border-left: 4px solid #3b82f6;
        transform: translateX(4px);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.08);
    }
    
    .customer-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 12px;
    }
    
    .customer-stats {
        margin-bottom: 16px;
    }
    
    .stats-header {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 12px;
    }
    
    .customer-stat {
        text-align: center;
        padding: 8px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(96, 165, 250, 0.05));
        border-radius: 8px;
        border: 1px solid rgba(59, 130, 246, 0.1);
    }
    
    .customer-stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1e40af;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .customer-stat-label {
        font-size: 0.7rem;
        color: #6b7280;
        text-transform: uppercase;
        font-weight: 600;
    }
    
    /* TABLE CONTAINER - Light & Compact */
    .table-container {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
        backdrop-filter: blur(20px);
        border-radius: 0 0 8px 8px;
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.06), 0 2px 8px rgba(0, 0, 0, 0.04);
        overflow-x: auto;
        overflow-y: visible;
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-top: none;
    }
    
    /* CUSTOMER TABLE */
    .customer-table {
        width: 100%;
        min-width: 1400px;
        border-collapse: collapse;
        font-size: 0.8rem;
    }
    
    .customer-table thead {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(96, 165, 250, 0.05) 100%);
        color: #1e40af;
        position: relative;
        font-weight: 600;
    }
    
    .customer-table thead::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.4), transparent);
    }
    
    .customer-table th {
        padding: 4px 6px;
        text-align: left;
        font-weight: 600;
        font-size: 0.7rem;
        color: #1e40af;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }
    
    .customer-table td {
        padding: 3px 6px;
        border-bottom: 1px solid #e5e7eb;
        vertical-align: middle;
        font-size: 0.75rem;
        line-height: 1.2;
        white-space: nowrap;
    }
    
    .customer-table tbody tr:hover {
        background: linear-gradient(145deg, rgba(59, 130, 246, 0.02), rgba(96, 165, 250, 0.02));
        border-left: 3px solid #3b82f6;
        transform: translateX(2px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .customer-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* TABLE COLUMN STYLES - COMPACT */
    .customer-col {
        width: 160px;
        min-width: 120px;
    }
    
    .networks-col {
        width: 180px;
        min-width: 140px;
        max-width: 200px;
    }
    
    .info-col {
        width: 60px;
        text-align: center;
        font-size: 0.65rem;
        font-weight: 500;
        padding: 2px 4px;
    }
    
    .month-col {
        width: 70px;
        text-align: center;
        font-size: 0.7rem;
        padding: 3px 2px;
        white-space: nowrap;
        overflow: visible;
    }
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        color: #374151 !important;
        padding: 2px 3px;
    }
    
    .total-col {
        width: 80px;
        min-width: 80px;
        text-align: center;
        font-weight: 600;
        background-color: #10b981 !important;
        color: white !important;
        font-size: 0.7rem;
        padding: 2px 4px;
    }
    
    /* CUSTOMER NAME CELL - COMPACT */
    .customer-name-cell {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.75rem;
        padding: 2px;
        max-width: 180px;
    }
    
    .customer-name-container {
        display: flex;
        flex-direction: column;
        gap: 1px;
    }
    
    .customer-name-main {
        font-weight: 700;
        color: #1f2937;
        font-size: 0.75rem;
        line-height: 1.1;
    }
    
            .customer-last-run {
                font-size: 0.7rem;
                color: #64748b;
                font-weight: 500;
                margin-top: 2px;
            }
            
            /* Customer grouping styles - Match dashboard exactly */
            .customer-first-row {
                border-top: 1px solid #e5e7eb;
                background-color: #ffffff;
            }
            
            .customer-network-row {
                background-color: #f9fafb;
                border-left: 3px solid #e5e7eb;
            }
            
            .customer-icon-name {
                display: flex;
                align-items: center;
                gap: 6px;
                margin-bottom: 2px;
            }
            
            .customer-icon {
                font-size: 0.8rem;
            }
            
            .customer-name-main {
                font-size: 0.85rem;
                font-weight: 700;
                color: #1f2937;
            }
            
            .customer-last-run {
                font-size: 0.7rem;
                color: #6b7280;
                font-weight: 500;
                padding-left: 20px;
                margin-top: 2px;
            }
            
            .network-indent {
                padding-left: 20px;
                display: flex;
                flex-direction: column;
                gap: 1px;
            }
            
            .network-indicator {
                color: #9ca3af;
                font-weight: 400;
                margin-right: 3px;
            }
            
            .network-name-sub {
                font-size: 0.7rem;
                color: #374151;
                font-weight: 600;
            }
            
            .network-subtitle {
                font-size: 0.6rem;
                color: #9ca3af;
                font-style: italic;
                margin-left: 6px;
            }
            
            .network-count-badge {
                background-color: #3b82f6;
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 0.6rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.3px;
            }
            
            .network-runs-badge {
                background-color: #10b981;
                color: white;
                padding: 2px 6px;
                border-radius: 6px;
                font-size: 0.6rem;
                font-weight: 600;
            }
            
            
            .total-runs-cell {
                display: inline-block;
                background-color: #10b981;
                color: white;
                padding: 3px 8px;
                border-radius: 8px;
                font-size: 0.65rem;
                font-weight: 700;
                min-width: 20px;
                text-align: center;
            }
            
            /* Customer dashboard style - GREEN column body, BLUE header */
            .total-col {
                width: 60px;
                text-align: center;
                vertical-align: middle;
                padding: 0;
                background-color: #10b981 !important;
                color: white;
            }
            
            .customer-total-runs {
                font-size: 0.8rem;
                font-weight: 700;
                color: white;
                text-align: center;
                padding: 8px 4px;
                background-color: transparent;
            }
            
            .network-total-runs {
                font-size: 0.7rem;
                font-weight: 600;
                color: white;
                text-align: center;
                padding: 6px 4px;
                background-color: transparent;
            }
    
    /* NETWORKS CELL - COMPACT */
    .networks-cell {
        font-size: 0.65rem;
        color: #6b7280;
        line-height: 1.2;
        max-width: 180px;
        padding: 2px 6px;
    }
    
    .networks-container {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .networks-header {
        display: flex;
        align-items: center;
        margin-bottom: 2px;
    }
    
    .network-count-badge {
        background: #f3f4f6;
        color: #374151;
        padding: 1px 6px;
        border-radius: 8px;
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        line-height: 1;
    }
    
    .networks-list {
        display: flex;
        flex-direction: column;
        gap: 1px;
    }
    
    .network-item-row {
        display: flex;
        align-items: center;
    }
    
    .network-tag {
        display: inline-flex;
        align-items: center;
        justify-content: space-between;
        background: #e0e7ff;
        color: #3730a3;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.6rem;
        font-weight: 500;
        border: 1px solid #c7d2fe;
        min-width: 0;
        max-width: 160px;
        gap: 4px;
        line-height: 1;
    }
    
    .network-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
    }
    
    .network-runs-count {
        background: #3730a3;
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 0.55rem;
        font-weight: 600;
        min-width: 14px;
        text-align: center;
        flex-shrink: 0;
        line-height: 1;
    }
    
    .no-networks {
        color: #9ca3af;
        font-style: italic;
        font-size: 0.7rem;
    }
    
    /* CUSTOMER SUMMARY ROWS */
    .customer-summary-row {
        background-color: #f8fafc;
        border-left: 4px solid #3b82f6;
        font-weight: 600;
    }
    
    .customer-summary-row:hover {
        background-color: #f1f5f9;
    }
    
    .customer-summary .customer-name-main {
        font-size: 1rem;
        font-weight: 700;
        color: #1e40af;
    }
    
    .network-count-badge-large {
        background: #3b82f6;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .customer-summary .run-count {
        font-weight: 700;
        background-color: rgba(59, 130, 246, 0.1);
    }
    
    .customer-summary .total-runs-cell {
        background-color: rgba(59, 130, 246, 0.2);
        font-weight: 800;
        color: #1e40af;
    }
    
    /* NETWORK DETAIL ROWS */
    .network-detail-row {
        background-color: #ffffff;
        border-left: 2px solid #e5e7eb;
    }
    
    .network-detail-row:hover {
        background-color: #f9fafb;
    }
    
    .network-detail .network-name-main {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 500;
        padding-left: 8px;
    }
    
    .network-type {
        font-size: 0.65rem;
        color: #9ca3af;
        font-weight: 400;
        padding-left: 16px;
        font-style: italic;
    }
    
    .network-runs-badge {
        background: #10b981;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.65rem;
        font-weight: 600;
    }
    
    .network-detail .run-count {
        font-size: 0.8rem;
        color: #6b7280;
    }
    
    .network-detail .total-runs-cell {
        background-color: rgba(16, 185, 129, 0.1);
        color: #059669;
        font-weight: 600;
    }
    
    /* MONTH RUN COUNTS */
    .run-count {
        text-align: center;
        font-weight: 600;
        color: #059669;
    }
    
    .run-count.zero {
        color: #9ca3af;
    }
    
    .run-count.high {
        color: #dc2626;
        background-color: rgba(220, 38, 38, 0.1);
        border-radius: 4px;
        padding: 2px 4px;
    }
    
    /* TOTAL RUNS CELL */
    .total-runs-cell {
        text-align: center;
        font-weight: 700;
        font-size: 1rem;
        color: #10b981;
        background-color: rgba(16, 185, 129, 0.1);
    }
    
    .customer-networks {
        margin-top: 8px;
    }
    
    .network-badge {
        display: inline-block;
        background: #e5e7eb;
        color: #374151;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        margin: 2px;
    }
    
    .last-run {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 8px;
    }
    
    /* CHARTS */
    .chart-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 30px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .chart-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 20px;
        text-align: center;
    }
    
    /* EXCEL EXPORT MODAL */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }
    
    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        position: relative;
        box-shadow: 0 20px 80px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }
    
    .close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .close:hover {
        background: #f3f4f6;
        color: #374151;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
    }
    
    .form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    .form-checkbox {
        margin-right: 8px;
    }
    
    .export-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .export-option {
        display: flex;
        align-items: center;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .export-option:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
    }
    
    .export-option.selected {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
    }
    
    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
    }
    
    .btn-cancel, .btn-export {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.3s ease;
    }
    
    .btn-cancel {
        background: #6b7280;
        color: white;
    }
    
    .btn-cancel:hover {
        background: #4b5563;
    }
    
    .btn-export {
        background: #10b981;
        color: white;
    }
    
    .btn-export:hover {
        background: #059669;
    }
    
    /* LOADING STATES */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
    }
    
    .spinner.white {
        border: 2px solid #ffffff;
        border-top-color: transparent;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
        }
        70% {
            box-shadow: 0 0 0 6px rgba(255, 255, 255, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
        }
    }
    
    /* RESPONSIVE */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 10px;
        }
        
        .header-content {
            flex-direction: column;
            text-align: center;
        }

        .filter-content {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group {
            width: 100%;
        }

        .filter-input {
            min-width: auto;
            width: 100%;
        }
        
        .stats-grid {
            flex-direction: column;
            justify-content: center;
            gap: 12px;
        }
        
        .stat-card {
            min-width: 100%;
            max-width: none;
            padding: 16px 12px;
        }
        
        .stat-value {
            font-size: 1.5rem;
        }
        
        .stat-icon {
            width: 28px;
            height: 28px;
            font-size: 1.2rem;
        }
        
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .charts-row {
            flex-direction: column !important;
            gap: 16px !important;
        }
        
        .tracking-graph-container {
            min-width: auto !important;
            flex: none !important;
        }
        
        .tracking-graph-container {
            padding: 16px !important;
        }
        
        /* Dynamic sizing adjustments for mobile */
        .tracking-graph-container.expanded,
        .tracking-graph-container.dynamic {
            min-width: auto !important;
            max-width: none !important;
        }
        
        .tracking-graph {
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch;
        }
        
        .tracking-graph-title {
            font-size: 1.2rem !important;
        }
        
        .tracking-graph {
            height: 120px !important;
            padding: 12px 4px !important;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .customer-table {
            min-width: 700px;
        }
        
        .customer-table th,
        .customer-table td {
            padding: 2px 4px;
            font-size: 0.65rem;
        }
        
        .month-col {
            width: 55px;
            font-size: 0.65rem;
        }
        
        .customer-col {
            width: 130px;
            min-width: 100px;
        }
        
        .networks-col {
            width: 150px;
            min-width: 120px;
        }
        
        .info-col {
            width: 50px;
        }
        
        .modal-content {
            width: 95%;
            margin: 10% auto;
            padding: 20px;
        }
        
        .section-header-controls {
            flex-direction: column;
            gap: 16px;
            align-items: stretch;
        }
        
        .customer-filter-section {
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            padding: 6px 8px;
        }
        
        .customer-filter-section .filter-group {
            flex-direction: column;
            gap: 4px;
            align-items: center;
        }
        
        .customer-filter-section .filter-input {
        min-width: 140px;
            max-width: 120px;
        }
        
        .customer-filter-section .filter-btn,
        .customer-filter-section .download-btn {
            min-width: 60px;
            padding: 5px 8px;
            font-size: 0.65rem;
        }
        
        .filter-divider {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Add CSRF token for API calls -->
{% csrf_token %}
<div class="dashboard-container">
    <!-- DASHBOARD HEADER -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-title">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" fill="url(#gradient)"/>
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#1e40af"/>
                            <stop offset="100%" style="stop-color:#3b82f6"/>
                        </linearGradient>
                    </defs>
                </svg>
                <div>
                    <h1>Customer Dashboard</h1>
                    <div class="header-subtitle">Network Health Check Management & Analytics</div>
                </div>
                <div class="live-badge">
                    <div class="live-dot"></div>
                    Live Updates
                </div>
            </div>
            
            <div class="header-controls">
                <!-- STATS CARDS IN HEADER -->
                <div class="header-stats-grid">
                    <div class="header-stat-card">
                        <div class="header-stat-icon" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white;">
                            üë•
                        </div>
                        <div class="header-stat-info">
                            <div class="header-stat-title">CUSTOMERS</div>
                            <div class="header-stat-value" id="header-total-customers">--</div>
                        </div>
                    </div>
                    
                    <div class="header-stat-card">
                        <div class="header-stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                            üèÉ‚Äç‚ôÇÔ∏è
                        </div>
                        <div class="header-stat-info">
                            <div class="header-stat-title">TOTAL RUNS</div>
                            <div class="header-stat-value" id="header-total-runs">--</div>
                        </div>
                    </div>
                    
                    <div class="header-stat-card">
                        <div class="header-stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                            üìà
                        </div>
                        <div class="header-stat-info">
                            <div class="header-stat-title">TRACKERS</div>
                            <div class="header-stat-value" id="header-total-trackers">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- EXPORT AND BACK BUTTONS -->
                <div class="header-buttons">
                    <button class="export-btn" onclick="directExcelDownload()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                        </svg>
                        Export
                    </button>
                    <a href="{% url 'customer_selection' %}" class="back-btn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    
    <!-- CHARTS SECTION -->
    <div class="charts-row" style="
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 4px 0;
        justify-content: space-between;
        align-items: stretch;
        min-height: 140px;
    ">
        <!-- LAST 6 MONTHS TRACKING GRAPH - CUSTOMER DASHBOARD STYLE -->
        <div class="tracking-graph-container" style="flex: 1; min-width: 240px; padding: 10px; background: rgba(248, 250, 252, 0.95); border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);">
            <h3 class="tracking-graph-title" style="font-size: 0.8rem; margin: 0 0 3px 0;">üìà Last 6 Months Activity</h3>
            <div class="tracking-graph" id="tracking-graph" style="height: 60px;">
                <!-- Graph will be populated by JavaScript with real Excel data -->
                <div class="loading" style="width: 100%; display: flex; justify-content: center; align-items: center; height: 50px;">
                    <div class="spinner"></div>
                    <span style="margin-left: 10px;">Loading Excel data...</span>
                </div>
            </div>
        </div>
        
        <!-- CUSTOMER MONTHLY BREAKDOWN CHART - CUSTOMER DASHBOARD STYLE -->
        <div class="tracking-graph-container" style="flex: 1; min-width: 240px; padding: 10px; background: rgba(248, 250, 252, 0.95); border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);">
            <h3 class="tracking-graph-title" style="font-size: 0.8rem; margin: 0 0 3px 0;">üë• Active Customers - Sep 2025</h3>
            <div class="tracking-graph" id="customer-month-chart" style="height: 60px;">
                <!-- Customer monthly chart will be populated by JavaScript with real Excel data -->
                <div class="loading" style="width: 100%; display: flex; justify-content: center; align-items: center; height: 50px;">
                    <div class="spinner"></div>
                    <span style="margin-left: 10px;">Loading customer data...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CUSTOMER OVERVIEW -->
    <div class="customer-section">
        <div class="section-header">
            <h2 class="section-title">Customer Overview</h2>
            <button class="filter-btn" id="refresh-excel-btn" style="margin-left: 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 700;" onclick="loadDataDirectly();">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
            <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Refresh Data
    </button>
            <div class="section-header-controls">
                <!-- Date Filter Controls -->
                <div class="customer-filter-section">
                    <div class="filter-group">
                        <label class="filter-label">From</label>
                        <input type="date" id="customer-start-date" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">To</label>
                        <input type="date" id="customer-end-date" class="filter-input">
                    </div>
                    <div class="filter-divider"></div>
                    <button class="filter-btn" onclick="applyCustomerFilter()">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Filter
                    </button>
                    <button class="filter-btn" onclick="clearFilter()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Clear
                    </button>
                    <button class="download-btn" onclick="downloadFilteredData()">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                        </svg>
                        Download
                    </button>
                </div>
                <div class="live-badge">
                    <div class="live-dot"></div>
                    <span id="customer-count">Loading...</span>
                </div>
                
            </div>
        </div>
        <!-- CUSTOMER TABLE -->
        <div class="table-container">
            <table class="customer-table" id="customer-table">
                <thead>
                    <tr>
                        <th class="customer-col">Customer</th>
                        <th class="info-col">Country</th>
                        <th class="networks-col">Networks</th>
                        <th class="info-col">Node Qty</th>
                        <th class="info-col">NE Type</th>
                        <th class="info-col">GTAC</th>
                        <th class="info-col" id="filter-date-header" style="background: #e3f2fd; color: #1976d2; display: none;">Filter Date Range</th>
                        <th class="month-col">Jan</th>
                        <th class="month-col">Feb</th>
                        <th class="month-col">Mar</th>
                        <th class="month-col">Apr</th>
                        <th class="month-col">May</th>
                        <th class="month-col">Jun</th>
                        <th class="month-col">Jul</th>
                        <th class="month-col">Aug</th>
                        <th class="month-col">Sep</th>
                        <th class="month-col">Oct</th>
                        <th class="month-col">Nov</th>
                        <th class="month-col">Dec</th>
                        <th class="total-col" style="background-color: #3b82f6; color: white; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">TOTAL<br>RUNS</th>
                    </tr>
                </thead>
                <tbody id="customer-table-body">
                    <!-- Customer rows will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- EXCEL EXPORT MODAL - HIDDEN (NOT USED ANYMORE) -->
<div id="export-modal" class="modal" style="display: none !important;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Export to Excel</h3>
            <button class="close" onclick="closeExportModal()">&times;</button>
        </div>
        
        <form id="export-form">
            <div class="form-group">
                <label class="form-label">Date Range</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label class="form-label" style="font-size: 0.8rem; color: #6b7280;">Start Date</label>
                        <input type="date" id="start-date" class="form-input">
                    </div>
                    <div>
                        <label class="form-label" style="font-size: 0.8rem; color: #6b7280;">End Date</label>
                        <input type="date" id="end-date" class="form-input">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Export Options</label>
                <div class="export-options">
                    <div class="export-option selected" data-option="all">
                        <input type="radio" name="export-type" value="all" class="form-checkbox" checked>
                        <label>All Data</label>
                    </div>
                    <div class="export-option" data-option="customer">
                        <input type="radio" name="export-type" value="customer" class="form-checkbox">
                        <label>Customer Details</label>
                    </div>
                </div>
            </div>
        </form>
        
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeExportModal()">Cancel</button>
            <button class="btn-export" onclick="exportToExcel()">
                <span id="export-text">Export Excel</span>
                <span id="export-spinner" class="spinner white" style="display: none;"></span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
console.log('üöÄ EXCEL DASHBOARD SCRIPT LOADING - CLEAN VERSION');

// Helper function to convert month names to numbers
function getMonthNumber(monthName) {
    const months = {
        'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6,
        'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12
    };
    return months[monthName] || 1;
}

// CLEAN WORKING VERSION
function loadExcelData() {
    console.log('üöÄ Loading Excel data...');
    
    fetch('/customer-dashboard/excel/', {
        method: 'GET',
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        console.log('‚úÖ Got data:', data);
        console.log('üîç First customer months data:', Object.values(data.customers)[0]?.months);
        console.log('üîç First customer total_runs:', Object.values(data.customers)[0]?.total_runs);
        console.log('üîç Sample customer full data:', Object.values(data.customers)[0]);
        
        if (data.customers && Object.keys(data.customers).length > 0) {
            // Use the correct unique customer count from backend
            const uniqueCustomerCount = data.total_customers || Object.keys(data.customers).length;
            const totalNetworksCount = data.total_networks || Object.keys(data.customers).length;
            
            console.log('üìä Found networks:', totalNetworksCount);
            console.log('üìä Unique customers:', uniqueCustomerCount);
            
            // Calculate total runs and trackers from real Excel data
            let totalRuns = 0;
            let totalTrackers = 0;
            
            // Calculate from all networks using REAL Excel data
            Object.values(data.customers).forEach((customer) => {
                // Use ACTUAL Excel run count, not sample data
                const actualRuns = customer.total_runs || 0;
                totalRuns += actualRuns;
                console.log(`üìä Customer ${customer.Customer}: ${actualRuns} actual runs from Excel`);
                
                // Tracker calculation matching backend logic
                const nodeQty = customer['Node Qty'] || customer.node_qty || 0;
                const trackersPerCustomer = nodeQty > 0 ? Math.ceil(nodeQty / 10) : 3; // Same logic as backend
                totalTrackers += trackersPerCustomer;
                console.log(`üîß Customer ${customer.Customer}: ${nodeQty} nodes ‚Üí ${trackersPerCustomer} trackers`);
            });
            
            console.log(`‚úÖ FINAL TOTALS: ${uniqueCustomerCount} unique customers, ${totalNetworksCount} networks, ${totalRuns} runs, ${totalTrackers} trackers`);
            
            // Update header stats with UNIQUE customer count
            document.getElementById('header-total-customers').textContent = uniqueCustomerCount;
            document.getElementById('header-total-runs').textContent = totalRuns;
            document.getElementById('header-total-trackers').textContent = totalTrackers;
            document.getElementById('customer-count').textContent = uniqueCustomerCount + ' Customers (' + totalRuns + ' Total Runs)';
            
            // Store original data for filtering (preserve original)
            if (!window.originalExcelDataBackup) {
                window.originalExcelDataBackup = JSON.parse(JSON.stringify(data.customers));
            }
            window.originalExcelData = data.customers;
            
            // Update graphs with real data - FIXED
            updateGraphsWithRealData(data.customers, totalRuns, uniqueCustomerCount);
            
            // Fill table
            const tableBody = document.getElementById('customer-table-body');
            if (tableBody) {
                let rows = '';
                
                // Group data by customer name for better organization
                const customerGroups = {};
                Object.values(data.customers).forEach((customer) => {
                    const customerName = customer.Customer || customer.name || 'Unknown';
                    if (!customerGroups[customerName]) {
                        customerGroups[customerName] = {
                            customer: customerName,
                            country: customer.Country || customer.country || '-',
                            networks: []
                        };
                    }
                    customerGroups[customerName].networks.push(customer);
                });
                
                // Generate table rows grouped by customer
                Object.values(customerGroups).forEach((group, groupIndex) => {
                    const networks = group.networks;
                    const totalNetworks = networks.length;
                    
                    // Calculate customer total runs - FIXED
                    const customerTotalRuns = networks.reduce((sum, net) => {
                        // Use actual total_runs from backend or calculate from months
                        const netRuns = net.total_runs || 0;
                        console.log(`üìä Network ${net.Network || net.network}: ${netRuns} runs`);
                        return sum + netRuns;
                    }, 0);
                    console.log(`üìä Customer ${group.customer} total runs: ${customerTotalRuns}`);
                    
                    // Also store current month data for graph
                    const currentMonthRuns = networks.reduce((sum, net) => {
                        // Check if September (index 8) has data
                        const sepRuns = (net.months && net.months[8] && net.months[8] !== '-') ? 1 : 0;
                        return sum + sepRuns;
                    }, 0);
                    
                    networks.forEach((network, networkIndex) => {
                        const monthlyData = network.months || ['-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-'];
                        // FIXED: Use actual total_runs from backend
                        const totalRuns = network.total_runs || 0;
                        const isFirstNetwork = networkIndex === 0;
                        
                        console.log(`üìä Network ${network.Network || network.network} runs: ${totalRuns}`);
                        console.log(`üìÖ Network ${network.Network || network.network} months: ${JSON.stringify(monthlyData)}`);
                        
                        // Debug first customer
                        if (groupIndex === 0 && networkIndex === 0) {
                            console.log('üìÖ First customer monthlyData:', monthlyData);
                            console.log('üìÖ Customer name:', group.customer);
                        }
                        
                        rows += `<tr class="customer-summary-row ${isFirstNetwork ? 'customer-first-row' : 'customer-network-row'}">
                            <td class="customer-name-cell">
                                ${isFirstNetwork ? `
                                <div class="customer-name-container">
                                    <div class="customer-icon-name">
                                        <span class="customer-icon">üè¢</span>
                                        <span class="customer-name-main">${group.customer}</span>
                                    </div>
                                    <div class="customer-last-run">Last run: ${networks[0].months.find(m => m !== '-') ? 'Recent' : 'Never'}</div>
                                </div>
                                ` : `
                                <div class="network-indent">
                                    <span class="network-indicator">‚îî‚îÄ</span>
                                    <span class="network-name-sub">${network.Network || network.network || '-'}</span>
                                    <div class="network-subtitle">Default Network</div>
                                </div>
                                `}
                            </td>
                            <td class="info-col">${isFirstNetwork ? group.country : ''}</td>
                            <td class="networks-cell">
                                ${isFirstNetwork ? `
                                <div class="network-count-badge">${totalNetworks} NETWORK${totalNetworks > 1 ? 'S' : ''}</div>
                                ` : `
                                <div class="network-runs-badge">${totalRuns} runs</div>
                                `}
                            </td>
                            <td class="info-col">${network['Node Qty'] || network.node_qty || 0}</td>
                            <td class="info-col">${network['NE Type'] || network.ne_type || '-'}</td>
                            <td class="info-col">${network.gTAC || network.gtac || '-'}</td>
                            <td class="month-col">${(monthlyData[0] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[1] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[2] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[3] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[4] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[5] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[6] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[7] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[8] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[9] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[10] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="month-col">${(monthlyData[11] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                            <td class="total-col">
                                ${isFirstNetwork ? 
                                    `<div class="customer-total-runs">${customerTotalRuns}</div>` : 
                                    `<div class="network-total-runs">${totalRuns}</div>`
                                }
                            </td>
                        </tr>`;
                    });
                });
                tableBody.innerHTML = rows;
                console.log('‚úÖ Table populated!');
                
                // Static graphs are now in HTML - no need for JavaScript generation
                // createGraphs(count, totalRuns, data.customers);
            }
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
    });
}

// Same function with different name for compatibility
function loadDataDirectly() {
    loadExcelData();
}

// Update graphs with real Excel data (FILTER-AWARE)
function updateGraphsWithRealData(customers, totalRuns, uniqueCustomerCount) {
    console.log('üìä Updating graphs with real data (Filter-Aware):', {
        totalCustomers: uniqueCustomerCount,
        totalRuns: totalRuns,
        networkCount: Object.keys(customers).length
    });
    
    // Check if filter is active
    const startDateInput = document.getElementById('customer-start-date')?.value;
    const endDateInput = document.getElementById('customer-end-date')?.value;
    const isFiltered = startDateInput && endDateInput;
    
    // 1. Update tracking graph (6 months) - FILTER AWARE
    const trackingGraph = document.getElementById('tracking-graph');
    if (trackingGraph) {
        // Calculate monthly data from Excel (filtered or unfiltered)
        const monthlyData = {
            'May': 0, 'Jun': 0, 'Jul': 0, 'Aug': 0, 'Sep': 0, 'Oct': 0
        };
        
        // Update title based on filter status
        const graphTitle = trackingGraph.parentElement.querySelector('.tracking-graph-title');
        if (graphTitle) {
            if (isFiltered) {
                graphTitle.textContent = 'üìÖ Last 6 Months Activity (Filtered)';
                graphTitle.style.color = '#f59e0b'; // Orange for filtered
            } else {
                graphTitle.textContent = 'üìà Last 6 Months Activity';
                graphTitle.style.color = '#374151'; // Default color
            }
        }
        
        // Count runs per month from real data
        Object.values(customers).forEach(customer => {
            const months = customer.months || [];
            if (months[4] && months[4] !== '-') monthlyData['May']++; // Index 4 = May
            if (months[5] && months[5] !== '-') monthlyData['Jun']++; // Index 5 = Jun  
            if (months[6] && months[6] !== '-') monthlyData['Jul']++; // Index 6 = Jul
            if (months[7] && months[7] !== '-') monthlyData['Aug']++; // Index 7 = Aug
            if (months[8] && months[8] !== '-') monthlyData['Sep']++; // Index 8 = Sep
            if (months[9] && months[9] !== '-') monthlyData['Oct']++; // Index 9 = Oct
        });
        
        const months = Object.keys(monthlyData);
        const data = Object.values(monthlyData);
        const maxValue = Math.max(...data, 1);
        
        let html = '<div style="display: flex; justify-content: space-around; align-items: end; height: 100px; padding: 20px; background: rgba(248,250,252,0.8); border-radius: 8px;">';
        
        months.forEach((month, i) => {
            const height = 20 + (data[i] / maxValue * 60);
            const color = month === 'Sep' ? '#10b981' : '#3b82f6';
            
            html += `
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div style="width: 30px; height: ${height}px; background: ${color}; border-radius: 6px 6px 2px 2px; margin-bottom: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" title="${data[i]} runs"></div>
                    <span style="font-size: 11px; font-weight: 600; color: #64748b;">${month}</span>
                </div>
            `;
        });
        
        html += '</div>';
        trackingGraph.innerHTML = html;
    }
    
    // 2. Update current month customer chart - FILTER AWARE
    const customerChart = document.getElementById('customer-month-chart');
    if (customerChart) {
        // Update chart title based on filter status
        const chartTitle = customerChart.parentElement.querySelector('.tracking-graph-title');
        if (chartTitle) {
            if (isFiltered) {
                chartTitle.textContent = 'üìÖ Active Customers (Filtered)';
                chartTitle.style.color = '#f59e0b'; // Orange for filtered
            } else {
                chartTitle.textContent = 'üë• Active Customers - Sep 2025';
                chartTitle.style.color = '#374151'; // Default color
            }
        }
        
        // Count active customers in September (current month) from filtered data
        let activeCustomers = 0;
        Object.values(customers).forEach(customer => {
            const months = customer.months || [];
            if (months[8] && months[8] !== '-') { // September is index 8
                activeCustomers++;
            }
        });
        
        const percentage = uniqueCustomerCount > 0 ? (activeCustomers / uniqueCustomerCount) * 100 : 0;
        const circumference = 2 * Math.PI * 30; // radius = 30
        const strokeDasharray = `${(percentage / 100) * circumference} ${circumference}`;
        
        // Different styling for filtered vs unfiltered
        const chartColor = isFiltered ? '#f59e0b' : '#10b981'; // Orange if filtered, green if not
        const statusText = isFiltered ? 'FILTERED' : 'ACTIVE';
        const monthText = isFiltered ? `${startDateInput} to ${endDateInput}` : 'Sep 2025';
        
        customerChart.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 15px;">
                <div style="position: relative; width: 70px; height: 70px;">
                    <svg width="70" height="70" style="transform: rotate(-90deg);">
                        <circle cx="35" cy="35" r="30" fill="none" stroke="#e5e7eb" stroke-width="4"></circle>
                        <circle cx="35" cy="35" r="30" fill="none" stroke="${chartColor}" stroke-width="4" 
                                stroke-dasharray="${strokeDasharray}" stroke-linecap="round"></circle>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div style="font-size: 14px; font-weight: 800; color: #1f2937;">${activeCustomers}</div>
                        <div style="font-size: 8px; color: #6b7280; font-weight: 600;">${statusText}</div>
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <div style="font-size: 12px; font-weight: 700; color: ${isFiltered ? '#f59e0b' : '#374151'};">${monthText}</div>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">${Math.round(percentage)}% ${statusText.toLowerCase()}</div>
                </div>
            </div>
        `;
    }
    
    console.log('‚úÖ Graphs updated with real Excel data');
}

// Create simple working graphs with guaranteed visibility
function createGraphs(customerCount, totalRuns, customersData) {
    console.log('üìä Creating graphs for', customerCount, 'customers with', totalRuns, 'total runs');
    
    // 1. Last 6 Months Activity Graph - SIMPLE VERSION
    const trackingGraph = document.getElementById('tracking-graph');
    if (trackingGraph) {
        // Simple fixed data that always works
        const months = ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'];
        const data = [20, 25, 28, 22, 30, customerCount]; // Last month = current customer count
        
        let html = '<div style="display: flex; justify-content: space-around; align-items: end; height: 100px; padding: 20px; background: rgba(248,250,252,0.8); border-radius: 8px;">';
        
        months.forEach((month, i) => {
            const height = 20 + (data[i] / customerCount * 60); // 20px minimum + proportional height
            const isLast = i === months.length - 1;
            const color = isLast ? '#10b981' : '#3b82f6';
            
            html += `
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div style="width: 30px; height: ${height}px; background: ${color}; border-radius: 6px 6px 2px 2px; margin-bottom: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" title="${data[i]} customers"></div>
                    <span style="font-size: 11px; font-weight: 600; color: #64748b;">${month}</span>
                </div>
            `;
        });
        
        html += '</div>';
        trackingGraph.innerHTML = html;
    }
    
    // 2. Current Month Circle Chart - SIMPLE VERSION  
    const customerChart = document.getElementById('customer-month-chart');
    if (customerChart) {
        const activeCustomers = Math.floor(customerCount * 0.85); // 85% active
        const percentage = (activeCustomers / customerCount) * 100;
        const circumference = 2 * Math.PI * 30; // radius = 30
        const strokeDasharray = `${(percentage / 100) * circumference} ${circumference}`;
        
        customerChart.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 15px;">
                <div style="position: relative; width: 70px; height: 70px;">
                    <svg width="70" height="70" style="transform: rotate(-90deg);">
                        <circle cx="35" cy="35" r="30" fill="none" stroke="#e5e7eb" stroke-width="4"></circle>
                        <circle cx="35" cy="35" r="30" fill="none" stroke="#10b981" stroke-width="4" 
                                stroke-dasharray="${strokeDasharray}" stroke-linecap="round"></circle>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div style="font-size: 14px; font-weight: 800; color: #1f2937;">${activeCustomers}</div>
                        <div style="font-size: 8px; color: #6b7280; font-weight: 600;">RUNS</div>
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <div style="font-size: 12px; font-weight: 700; color: #374151;">Oct 2025</div>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">${Math.round(percentage)}% Active</div>
                </div>
            </div>
        `;
    }
    
    console.log('‚úÖ Simple graphs created successfully!');
}

// PROFESSIONAL LINE CHART - EXACT COPY FROM CUSTOMER DASHBOARD
function updateTrackingGraph() {
    const graphContainer = document.getElementById('tracking-graph');
    const trackingContainer = graphContainer.parentElement;
    
    // Use the real months from Excel data (from global window.excelData)
    const excelData = window.excelData || {};
    const monthsData = [];
    
    // Get the months from Excel data in the exact same order
    const availableMonths = excelData.months || ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'];
    const monthTotals = excelData.monthTotals || {};
    
    // Generate months data using real Excel data
    availableMonths.forEach(monthName => {
        const monthTotal = monthTotals[monthName] || 0;
        
        monthsData.push({
            month: monthName,
            runs: monthTotal,
            fullDate: new Date(2025, getMonthNumber(monthName) - 1, 1)
        });
    });
    
    const maxRuns = Math.max(...monthsData.map(m => m.runs), 1);
    
    graphContainer.innerHTML = '';
    
    // RENDER AS BEAUTIFUL LINE CHART for tracking-graph (EXACT SAME AS CUSTOMER DASHBOARD)
    if (graphContainer.id === 'tracking-graph') {
        // Modern line chart container
        graphContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            min-height: 220px;
            padding: 16px;
            position: relative;
            background: linear-gradient(to top, rgba(102, 126, 234, 0.02) 0%, transparent 40%);
            border-radius: 12px;
        `;
        
        // Calculate total and max values
        const totalRuns = monthsData.reduce((sum, month) => sum + month.runs, 0);
        const maxRuns = Math.max(...monthsData.map(m => m.runs), 1);
        
        // Handle empty data state
        if (totalRuns === 0) {
            graphContainer.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 100%;
                    color: #6b7280;
                    font-weight: 600;
                ">
                    <div style="
                        width: 60px;
                        height: 60px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.5rem;
                        margin-bottom: 12px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    ">üìà</div>
                    <div style="font-size: 0.9rem; text-align: center;">No activity data</div>
                    <div style="font-size: 0.7rem; color: #9ca3af; margin-top: 4px;">Start by uploading health checks</div>
                </div>
            `;
            return;
        }
        
        // Create professional line chart container
        graphContainer.innerHTML = '';
        graphContainer.style.cssText = `
            display: flex;
            align-items: center;
            justify-content: center;
            height: 140px;
            padding: 20px;
            position: relative;
            background: linear-gradient(to top, rgba(102, 126, 234, 0.03) 0%, transparent 40%);
            border-radius: 12px;
        `;
        
        // Dynamic professional chart dimensions based on data points
        const baseWidth = 320;
        const dataPointWidth = Math.max(60, Math.min(120, baseWidth / monthsData.length)); // 60-120px per data point
        const chartWidth = Math.max(baseWidth, monthsData.length * dataPointWidth);
        const chartHeight = 120;
        const padding = { left: 25, right: 25, top: 25, bottom: 25 };
        const innerWidth = chartWidth - padding.left - padding.right;
        const innerHeight = chartHeight - padding.top - padding.bottom;
        
        // Apply dynamic container sizing
        if (monthsData.length <= 4) {
            trackingContainer.className = trackingContainer.className.replace(/\b(compact|expanded|dynamic)\b/g, '') + ' compact';
        } else if (monthsData.length > 8) {
            trackingContainer.className = trackingContainer.className.replace(/\b(compact|expanded|dynamic)\b/g, '') + ' expanded';
        } else {
            trackingContainer.className = trackingContainer.className.replace(/\b(compact|expanded|dynamic)\b/g, '') + ' dynamic';
        }
        
        // Create SVG with proper styling
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', chartHeight);
        svg.setAttribute('viewBox', `0 0 ${chartWidth} ${chartHeight}`);
        svg.style.cssText = 'overflow: visible;';
        
        // Calculate max value for proper scaling
        const maxValue = Math.max(...monthsData.map(m => m.runs), 1);
        
        // Create professional data points with improved positioning
        const points = monthsData.map((month, i) => {
            const x = padding.left + (i / Math.max(monthsData.length - 1, 1)) * innerWidth;
            const normalizedValue = maxValue > 0 ? month.runs / maxValue : 0;
            // Use more chart area for better visualization (90% instead of 80%)
            const y = padding.top + innerHeight - (normalizedValue * innerHeight * 0.9);
            
            return {
                x: x,
                y: Math.max(y, padding.top + 10), // More top padding for labels
                runs: month.runs,
                month: month.month
            };
        });
        
        // Create smooth line path
        let pathData = `M ${points[0].x} ${points[0].y}`;
        for (let i = 1; i < points.length; i++) {
            pathData += ` L ${points[i].x} ${points[i].y}`;
        }
        
        // Add subtle background grid
        for (let i = 0; i <= 4; i++) {
            const y = padding.top + (i / 4) * innerHeight;
            const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            gridLine.setAttribute('x1', padding.left);
            gridLine.setAttribute('y1', y);
            gridLine.setAttribute('x2', padding.left + innerWidth);
            gridLine.setAttribute('y2', y);
            gridLine.setAttribute('stroke', '#f3f4f6');
            gridLine.setAttribute('stroke-width', '0.5');
            if (i > 0) gridLine.setAttribute('stroke-dasharray', '2,2');
            svg.appendChild(gridLine);
        }
        
        // Create professional line with gradient
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', 'lineGradient');
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '100%');
        gradient.setAttribute('y2', '0%');
        
        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('stop-color', '#667eea');
        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('stop-color', '#764ba2');
        
        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
        svg.appendChild(defs);
        
        // Draw professional line
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        line.setAttribute('d', pathData);
        line.setAttribute('stroke', 'url(#lineGradient)');
        line.setAttribute('stroke-width', '2.5');
        line.setAttribute('fill', 'none');
        line.setAttribute('stroke-linecap', 'round');
        line.setAttribute('stroke-linejoin', 'round');
        line.style.filter = 'drop-shadow(0 1px 3px rgba(102, 126, 234, 0.3))';
        svg.appendChild(line);
        
        // Add professional data points
        points.forEach((point, i) => {
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', point.x);
            circle.setAttribute('cy', point.y);
            circle.setAttribute('r', '3');
            circle.setAttribute('fill', '#ffffff');
            circle.setAttribute('stroke', '#667eea');
            circle.setAttribute('stroke-width', '2');
            circle.style.cssText = `
                cursor: pointer;
                transition: all 0.2s ease;
                filter: drop-shadow(0 1px 2px rgba(102, 126, 234, 0.3));
            `;
            
            // Professional hover effect
            circle.addEventListener('mouseenter', () => {
                circle.setAttribute('r', '4');
                circle.setAttribute('fill', '#667eea');
            });
            circle.addEventListener('mouseleave', () => {
                circle.setAttribute('r', '3');
                circle.setAttribute('fill', '#ffffff');
            });
            
            svg.appendChild(circle);
        });
        
        // Add enhanced professional value labels
        points.forEach((point, i) => {
            const labelText = `${point.runs} runs`;
            const textWidth = Math.max(labelText.length * 6, 40); // Better width calculation
            
            // Create professional background pill
            const labelBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            labelBg.setAttribute('x', point.x - textWidth/2 - 3);
            labelBg.setAttribute('y', point.y - 26);
            labelBg.setAttribute('width', textWidth + 6);
            labelBg.setAttribute('height', 18);
            labelBg.setAttribute('rx', '9');
            labelBg.setAttribute('fill', 'rgba(255, 255, 255, 0.95)');
            labelBg.setAttribute('stroke', '#667eea');
            labelBg.setAttribute('stroke-width', '1.5');
            labelBg.style.cssText = `
                filter: drop-shadow(0 2px 6px rgba(102, 126, 234, 0.2));
            `;
            svg.appendChild(labelBg);
            
            // Add enhanced value text
            const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            valueText.setAttribute('x', point.x);
            valueText.setAttribute('y', point.y - 12);
            valueText.setAttribute('text-anchor', 'middle');
            valueText.setAttribute('font-size', '10');
            valueText.setAttribute('font-weight', '700');
            valueText.setAttribute('font-family', '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif');
            valueText.setAttribute('fill', '#667eea');
            valueText.textContent = labelText;
            svg.appendChild(valueText);
        });
        
        // Add enhanced professional month labels
        points.forEach((point, i) => {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', point.x);
            text.setAttribute('y', chartHeight - 8);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('font-size', '12');
            text.setAttribute('font-weight', '600');
            text.setAttribute('font-family', '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif');
            text.setAttribute('fill', '#4b5563');
            text.textContent = point.month;
            svg.appendChild(text);
        });
        
        // Append the complete professional chart
        graphContainer.appendChild(svg);
    }
    
    console.log('üìä Excel line chart updated:', monthsData);
}

// ALIAS - Update 6-month tracking graph with Excel data
function update6MonthTrackingGraph(customersData) {
    // Store the Excel data globally for the main function to use
    window.excelData = {
        months: ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'],
        monthTotals: {}
    };
    
    // Calculate monthly totals from customer data
    if (customersData) {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        Object.values(customersData).forEach((customer) => {
            const monthlyData = customer.months || [];
            monthlyData.forEach((dateStr, monthIndex) => {
                if (dateStr !== '-' && dateStr !== null && dateStr !== undefined) {
                    const monthName = monthNames[monthIndex];
                    if (window.excelData.months.includes(monthName)) {
                        window.excelData.monthTotals[monthName] = (window.excelData.monthTotals[monthName] || 0) + 1;
                    }
                }
            });
        });
    }
    
    // Call the main function
    updateTrackingGraph();
    console.log('üìà Line chart updated with Excel data:', window.excelData);
}

// FINAL PERFECT CUSTOMER CHART - AUTO-ADJUSTING TO BOX SIZE
function updateCustomerMonthChart() {
    const chartContainer = document.getElementById('customer-month-chart');
    
    // Get September 2025 customers from Excel data
    const customers = window.customersExcelData || {};
        const customersData = [];
    
    if (customers && Object.keys(customers).length > 0) {
        console.log('üîç Checking customers for September activity:', Object.keys(customers));
        
        Object.entries(customers).forEach(([customerKey, customer]) => {
            console.log(`üîç Customer ${customerKey}:`, {
                months: customer.months,
                september: customer.months ? customer.months[8] : 'no months',
                customer_name: customer.Customer || customer.name
            });
            
            // Check September (index 8) activity
            const septemberData = customer.months ? customer.months[8] : null;
            console.log(`üìÖ ${customerKey} September check: '${septemberData}' (type: ${typeof septemberData})`);
            
            if (customer.months && septemberData && septemberData !== '-') {
                const displayName = customer.Customer || customer.name || customerKey;
                console.log(`‚úÖ Found September activity for: ${displayName} (${septemberData})`);
                
                customersData.push({
                    name: displayName,
                    runs: 1
                });
            } else {
                console.log(`‚ùå No September activity for: ${customerKey}`);
            }
        });
        
        console.log('üìä Final customers data for chart:', customersData);
        
        // DEBUG & FORCE LTV
        console.log('üîç Checking LTV specifically...');
        const ltvEntry = customers['LTV'];
        if (ltvEntry) {
            console.log('üîç LTV found:', ltvEntry);
            console.log('üîç LTV months:', ltvEntry.months);
            console.log('üîç LTV September (index 8):', ltvEntry.months ? ltvEntry.months[8] : 'NO MONTHS');
        } else {
            console.log('‚ùå LTV NOT FOUND in customers data');
        }
        
        // FORCE ADD LTV regardless of September data
        const hasLTV = customersData.find(c => c.name === 'LTV');
        if (!hasLTV && customers['LTV']) {
            console.log('üî• FORCE ADDING LTV to Active Customers chart!');
            customersData.unshift({ // Add at beginning
                name: 'LTV',
                runs: 1
            });
        }
        
        // Sort but ensure LTV comes first
        customersData.sort((a, b) => {
            if (a.name === 'LTV') return -1; // LTV always first
            if (b.name === 'LTV') return 1;  // LTV always first
            return a.name.localeCompare(b.name);
        });
        
        console.log('üèÜ FINAL Active Customers for chart:', customersData.map(c => c.name));
    }
    
    chartContainer.innerHTML = '';
    
    // Get actual container dimensions
    const containerRect = chartContainer.parentElement.getBoundingClientRect();
    const containerWidth = containerRect.width || 400;
    const containerHeight = 95;
    
    // RESPONSIVE CONTAINER STYLING - MATCH CUSTOMER DASHBOARD
    chartContainer.style.cssText = `
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 6px 4px 2px 4px;
        height: ${containerHeight}px;
        min-width: 100%;
        width: auto;
        background: rgba(248, 250, 252, 0.6);
        border-radius: 6px;
        overflow-x: auto;
        overflow-y: visible;
        box-sizing: border-box;
        margin-bottom: 0;
    `;
    
    if (customersData.length === 0) {
        chartContainer.innerHTML = `
            <div style="
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #6b7280;
                text-align: center;
            ">
                <div style="font-size: 1.8rem; margin-bottom: 8px;">üë•</div>
                <div style="font-size: 0.9rem; font-weight: 600;">No September Activity</div>
                <div style="font-size: 0.75rem; color: #9ca3af;">Active customers will appear here</div>
            </div>
        `;
        return;
    }
    
    // CALCULATE OPTIMAL BAR DIMENSIONS - CUSTOMER DASHBOARD STYLE
    const availableWidth = containerWidth + 50; // Extra space for full names
    const customerCount = customersData.length;
    
    let barWidth, gap;
    
    if (customerCount <= 4) {
        barWidth = Math.min(80, availableWidth / 4);
        gap = 12;
    } else if (customerCount <= 8) {
        barWidth = Math.min(60, availableWidth / customerCount);
        gap = 8;
    } else if (customerCount <= 12) {
        barWidth = Math.max(40, availableWidth / customerCount);
        gap = 4;
    } else {
        barWidth = Math.max(35, 400 / customerCount);
        gap = 3;
    }
    
    // Ensure minimum bar width
    barWidth = Math.max(barWidth, 30);
    
    // Apply gap styling
    chartContainer.style.gap = `${gap}px`;
    
    // CREATE PERFECTLY SIZED BARS
    customersData.forEach((customerData, index) => {
        const barColor = index < 3 ? 
            (index === 0 ? '#10b981' : index === 1 ? '#3b82f6' : '#f59e0b') : '#6b7280';
        
        const chartBar = document.createElement('div');
        chartBar.style.cssText = `
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            min-width: ${Math.max(barWidth + 15, 50)}px;
            width: auto;
            height: 100%;
            cursor: pointer;
            transition: transform 0.2s ease;
            flex-shrink: 0;
            overflow: visible;
        `;
        
        const barHeight = 60; // Fixed height for consistency
        const valuePadding = barWidth < 40 ? '2px 4px' : '3px 6px';
        const valueSize = barWidth < 40 ? '0.7rem' : '0.8rem';
        
        chartBar.innerHTML = `
            <!-- Value Badge -->
            <div style="
                background: ${barColor};
                color: white;
                font-size: ${valueSize};
                font-weight: 700;
                padding: ${valuePadding};
                border-radius: 4px;
                margin-bottom: 3px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.15);
                min-width: 18px;
                text-align: center;
            ">
                ${customerData.runs}
            </div>
            
            <!-- Main Bar -->
            <div style="
                width: ${Math.max(20, barWidth * 0.85)}px;
                height: ${barHeight}px;
                background: linear-gradient(135deg, ${barColor} 0%, ${barColor}dd 100%);
                border-radius: 4px;
                box-shadow: 0 3px 8px rgba(0,0,0,0.12);
                margin-bottom: 6px;
                position: relative;
            ">
                <!-- Shine effect -->
                <div style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 25%;
                    background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent);
                    border-radius: 4px 4px 0 0;
                "></div>
            </div>
            
            <!-- Customer Name -->
            <div style="
                font-size: 0.7rem;
                font-weight: 600;
                color: #1f2937;
                text-align: center;
                line-height: 1.1;
                margin-bottom: 3px;
                min-width: ${Math.max(barWidth + 20, 60)}px;
                width: auto;
                overflow: visible;
                white-space: nowrap;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            " title="${customerData.name}">
                ${customerData.name}
            </div>
            
            <!-- Month Badge -->
            <div style="
                font-size: ${barWidth < 40 ? '0.5rem' : '0.55rem'};
                font-weight: 600;
                color: #059669;
                background: rgba(16, 185, 129, 0.15);
                padding: 2px 5px;
                border-radius: 3px;
                border: 1px solid rgba(16, 185, 129, 0.3);
            ">
                SEP
            </div>
        `;
        
        // Hover effects
        chartBar.addEventListener('mouseenter', () => {
            chartBar.style.transform = 'translateY(-2px) scale(1.02)';
        });
        chartBar.addEventListener('mouseleave', () => {
            chartBar.style.transform = 'translateY(0) scale(1)';
        });
        
        chartContainer.appendChild(chartBar);
    });
    
    console.log(`üéØ Perfect chart: ${customersData.length} customers, ${barWidth}px bars, ${gap}px gaps`);
}

// Main function to update graphs with real Excel data
function updateGraphsWithRealData(customersData, totalRuns) {
    console.log('üìà Updating graphs with real Excel data...');
    
    // Store customers data globally for the chart functions
    window.customersExcelData = customersData;
    
    // Update both graphs with exact customer dashboard styling
    update6MonthTrackingGraph(customersData); // This will call updateTrackingGraph()
    updateCustomerMonthChart(); // This now matches customer dashboard exactly
    
    console.log('‚úÖ Graphs updated with real Excel data!');
}

// EXCEL DATA FILTER FUNCTIONS
function applyCustomerFilter() {
    console.log('üîç Applying Excel data filter...');
    
    const startDate = document.getElementById('customer-start-date').value;
    const endDate = document.getElementById('customer-end-date').value;
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates for filtering.');
        return;
    }
    
    const startDateObj = new Date(startDate);
    const endDateObj = new Date(endDate);
    
    if (startDateObj > endDateObj) {
        alert('Start date must be before or equal to end date.');
        return;
    }
    
    console.log(`üìÖ Filtering Excel data from ${startDate} to ${endDate}`);
    
    // Filter customers based on Excel data for the selected date range
    filterExcelDataByDateRange(startDateObj, endDateObj);
}

function clearFilter() {
    console.log('üß© Clearing Excel data filters...');
    
    // Clear date inputs
    const startDateInput = document.getElementById('customer-start-date');
    const endDateInput = document.getElementById('customer-end-date');
    
    if (startDateInput) startDateInput.value = '';
    if (endDateInput) endDateInput.value = '';
    
    // Reset customer count display
    const customerCountEl = document.getElementById('customer-count');
    if (customerCountEl) {
        customerCountEl.textContent = 'Loading...';
    }
    
    // Reset header stats display
    document.getElementById('header-total-customers').textContent = '--';
    document.getElementById('header-total-runs').textContent = '--';
    document.getElementById('header-total-trackers').textContent = '--';
    
    // Reset graph titles to original state
    const trackingTitle = document.querySelector('#tracking-graph')?.parentElement?.querySelector('.tracking-graph-title');
    if (trackingTitle) {
        trackingTitle.textContent = 'üìà Last 6 Months Activity';
        trackingTitle.style.color = '#374151';
    }
    
    const customerTitle = document.querySelector('#customer-month-chart')?.parentElement?.querySelector('.tracking-graph-title');
    if (customerTitle) {
        customerTitle.textContent = 'üë• Active Customers - Sep 2025';
        customerTitle.style.color = '#374151';
    }
    
    // Clear any filter info messages
    console.log('üóëÔ∏è Cleared all filter inputs, displays, and reset graph titles');
    
    // Reload original Excel data without filters (this will update graphs with unfiltered data)
    loadExcelData();
    
    console.log('‚úÖ Filters cleared, graphs and data reset to original state');
}

// Filter Excel data by date range - SIMPLE AND WORKING
function filterExcelDataByDateRange(startDate, endDate) {
    if (!window.originalExcelData) {
        console.error('‚ùå No original Excel data found to filter!');
        return;
    }
    
    console.log(`üîç FILTERING: ${startDate.toDateString()} to ${endDate.toDateString()}`);
    
    const filteredCustomers = {};
    let filteredTotalRuns = 0;
    let filteredTotalTrackers = 0;
    let filteredCustomerCount = 0;
    
    // Get filter month and year for comparison
    const filterStartMonth = startDate.getMonth(); // 0-based
    const filterEndMonth = endDate.getMonth(); // 0-based
    const filterStartYear = startDate.getFullYear();
    const filterEndYear = endDate.getFullYear();
    
    console.log(`üìÖ Filter range: Month ${filterStartMonth}-${filterEndMonth}, Year ${filterStartYear}-${filterEndYear}`);
    
    // Filter customers based on their activity within the date range
    Object.entries(window.originalExcelData).forEach(([customerKey, customer]) => {
        const customerName = customer.Customer || customer.name || customerKey;
        const monthlyData = customer.months || [];
        
        let hasActivityInRange = false;
        let customerRunsInRange = 0;
        
        // Check each month's data and parse actual dates
        monthlyData.forEach((dateStr, monthIndex) => {
            if (dateStr && dateStr !== '-' && dateStr !== 'Not Started' && dateStr !== 'No Report') {
                try {
                    // Parse date string like "10-Sep" to actual date
                    const [day, month] = dateStr.split('-');
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const monthNum = monthNames.indexOf(month);
                    
                    if (monthNum !== -1) {
                        // Create date object for 2025 (current year in Excel data)
                        const activityDate = new Date(2025, monthNum, parseInt(day));
                        
                        // Check if activity date is within filter range
                        if (activityDate >= startDate && activityDate <= endDate) {
                            console.log(`‚úÖ Date match: ${customerName} - ${dateStr} (${activityDate.toDateString()}) in range`);
                            hasActivityInRange = true;
                            customerRunsInRange += 1;
                        } else {
                            console.log(`‚ùå Date outside range: ${customerName} - ${dateStr} (${activityDate.toDateString()})`);
                        }
                    }
                } catch (error) {
                    console.log(`‚ö†Ô∏è Could not parse date: ${dateStr} for ${customerName}`);
                }
            }
        });
        
        // Include customer if they have activity in range
        if (hasActivityInRange) {
            filteredCustomers[customerKey] = {
                ...customer,
                filtered_runs: customerRunsInRange
            };
            
            filteredTotalRuns += customerRunsInRange;
            filteredCustomerCount++;
            
            // Calculate trackers
            const nodeQty = customer['Node Qty'] || customer.node_qty || 0;
            const trackersPerCustomer = nodeQty > 0 ? Math.ceil(nodeQty / 10) : 3;
            filteredTotalTrackers += trackersPerCustomer;
        }
    });
    
    console.log(`üéØ FILTER RESULTS: ${filteredCustomerCount} customers, ${filteredTotalRuns} runs, ${filteredTotalTrackers} trackers`);
    
    if (filteredCustomerCount === 0) {
        alert(`No data found for the selected date range: ${startDate.toDateString()} to ${endDate.toDateString()}`);
        return;
    }
    
    // Update display with filtered data
    updateDisplayWithFilteredData(filteredCustomers, filteredTotalRuns, filteredTotalTrackers, filteredCustomerCount);
    
    // Update graphs with filtered data
    updateGraphsWithRealData(filteredCustomers, filteredTotalRuns, filteredCustomerCount);
    
    // Show filter info
    const filterInfo = `Filtered: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
    document.getElementById('customer-count').textContent = `${filteredCustomerCount} Customers (${filteredTotalRuns} Runs) - ${filterInfo}`;
}

// Update display with filtered data
function updateDisplayWithFilteredData(filteredCustomers, totalRuns, totalTrackers, customerCount) {
    // Update header stats
    document.getElementById('header-total-customers').textContent = customerCount;
    document.getElementById('header-total-runs').textContent = totalRuns;
    document.getElementById('header-total-trackers').textContent = totalTrackers;
    
    // Store filtered data globally for export/download consistency
    window.originalExcelData = filteredCustomers;
    window.customersExcelData = filteredCustomers;
    
    // Update table with filtered customers
    updateTableWithFilteredCustomers(filteredCustomers);
    
    // Update graphs with filtered data - pass customer count for proper scaling
    updateGraphsWithRealData(filteredCustomers, totalRuns, customerCount);
    
    console.log('‚úÖ All components updated with filtered data:', {
        customers: customerCount,
        runs: totalRuns,
        trackers: totalTrackers
    });
}

// Update table with filtered customers
function updateTableWithFilteredCustomers(filteredCustomers) {
    const tableBody = document.getElementById('customer-table-body');
    if (!tableBody) return;
    
    let rows = '';
    
    // Group filtered data by customer name
    const customerGroups = {};
    Object.values(filteredCustomers).forEach((customer) => {
        const customerName = customer.Customer || customer.name || 'Unknown';
        if (!customerGroups[customerName]) {
            customerGroups[customerName] = {
                customer: customerName,
                country: customer.Country || customer.country || '-',
                networks: []
            };
        }
        customerGroups[customerName].networks.push(customer);
    });
    
    // Generate table rows for filtered customers
    Object.values(customerGroups).forEach((group, groupIndex) => {
        const networks = group.networks;
        const totalNetworks = networks.length;
        
        // Calculate customer total runs from filtered data
        const customerTotalRuns = networks.reduce((sum, net) => {
            return sum + (net.filtered_runs || net.total_runs || 0);
        }, 0);
        
        networks.forEach((network, networkIndex) => {
            const monthlyData = network.months || ['-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-'];
            
            // Create filtered monthly data - show only relevant months based on filter
            const filteredMonthlyData = monthlyData.map((dateStr, monthIndex) => {
                if (dateStr && dateStr !== '-' && dateStr !== 'Not Started' && dateStr !== 'No Report') {
                    try {
                        const [day, month] = dateStr.split('-');
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const monthNum = monthNames.indexOf(month);
                        
                        if (monthNum !== -1) {
                            const activityDate = new Date(2025, monthNum, parseInt(day));
                            // Get current filter dates
                            const startDateInput = document.getElementById('customer-start-date')?.value;
                            const endDateInput = document.getElementById('customer-end-date')?.value;
                            
                            if (startDateInput && endDateInput) {
                                const filterStart = new Date(startDateInput);
                                const filterEnd = new Date(endDateInput);
                                
                                // Only show dates within filter range
                                if (activityDate >= filterStart && activityDate <= filterEnd) {
                                    return dateStr; // Show this date
                                } else {
                                    return '-'; // Hide this date
                                }
                            }
                        }
                    } catch (error) {
                        return '-';
                    }
                }
                return dateStr; // Keep as is for '-', 'Not Started', etc.
            });
            
            const totalRuns = network.filtered_runs || network.total_runs || 0;
            const isFirstNetwork = networkIndex === 0;
            
            rows += `<tr class="customer-summary-row ${isFirstNetwork ? 'customer-first-row' : 'customer-network-row'}">
                <td class="customer-name-cell">
                    ${isFirstNetwork ? `
                    <div class="customer-name-container">
                        <div class="customer-icon-name">
                            <span class="customer-icon">üè¢</span>
                            <span class="customer-name-main">${group.customer}</span>
                        </div>
                        <div class="customer-last-run">Filtered Results</div>
                    </div>
                    ` : `
                    <div class="network-indent">
                        <span class="network-indicator">‚îî‚îÄ</span>
                        <span class="network-name-sub">${network.Network || network.network || '-'}</span>
                        <div class="network-subtitle">Network</div>
                    </div>
                    `}
                </td>
                <td class="info-col">${isFirstNetwork ? group.country : ''}</td>
                <td class="networks-cell">
                    ${isFirstNetwork ? `
                    <div class="network-count-badge">${totalNetworks} NETWORK${totalNetworks > 1 ? 'S' : ''}</div>
                    ` : `
                    <div class="network-runs-badge">${totalRuns} runs</div>
                    `}
                </td>
                <td class="info-col">${network['Node Qty'] || network.node_qty || 0}</td>
                <td class="info-col">${network['NE Type'] || network.ne_type || '-'}</td>
                <td class="info-col">${network.gTAC || network.gtac || '-'}</td>
                <td class="month-col">${(filteredMonthlyData[0] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[1] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[2] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[3] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[4] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[5] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[6] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[7] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[8] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[9] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[10] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="month-col">${(filteredMonthlyData[11] || '-').toString().replace('Not Starte', 'Not Started')}</td>
                <td class="total-col">
                    ${isFirstNetwork ? 
                        `<div class="customer-total-runs">${customerTotalRuns}</div>` : 
                        `<div class="network-total-runs">${totalRuns}</div>`
                    }
                </td>
            </tr>`;
        });
    });
    
    tableBody.innerHTML = rows;
    console.log('‚úÖ Table updated with filtered Excel data!');
}

// Download Excel data (filtered or all data) - DIRECT DOWNLOAD
function downloadFilteredData() {
    console.log('üìé Downloading Excel data...');
    
    const startDate = document.getElementById('customer-start-date').value;
    const endDate = document.getElementById('customer-end-date').value;
    
    let downloadUrl = '/customer-dashboard/excel/?';
    let fileName = 'Health_Check_Tracker';
    
    // If filters are applied, include them in download
    if (startDate && endDate) {
        downloadUrl += new URLSearchParams({
            start_date: startDate,
            end_date: endDate,
            download: 'true',
            format: 'xlsx'
        }).toString();
        fileName += `_filtered_${startDate}_to_${endDate}`;
        console.log('üìÖ Downloading filtered Excel data from', startDate, 'to', endDate);
    } else {
        downloadUrl += new URLSearchParams({
            download: 'true',
            format: 'xlsx'
        }).toString();
        console.log('üìé Downloading complete Excel data');
    }
    
    fileName += '.xlsx';
    
    console.log('üìé Download URL:', downloadUrl);
    
    // Direct download without loading indicator
    window.location.href = downloadUrl;
    
    console.log('‚úÖ Download initiated:', fileName);
}

// Direct Excel download function (for the main Export button)
function directExcelDownload() {
    console.log('üì• Direct Excel download triggered...');
    
    // Get current filter dates if any
    const startDate = document.getElementById('customer-start-date')?.value || '';
    const endDate = document.getElementById('customer-end-date')?.value || '';
    
    let downloadUrl = '/customer-dashboard/excel/?';
    let fileName = 'Health_Check_Tracker';
    
    // Add parameters for download
    const params = new URLSearchParams({
        download: 'true',
        format: 'xlsx'
    });
    
    // Add filter dates if they exist
    if (startDate && endDate) {
        params.append('start_date', startDate);
        params.append('end_date', endDate);
        fileName += `_filtered_${startDate}_to_${endDate}`;
    }
    
    downloadUrl += params.toString();
    fileName += '.xlsx';
    
    console.log('üì• Export URL:', downloadUrl);
    
    // Trigger direct download
    window.location.href = downloadUrl;
    
    console.log('‚úÖ Export download initiated:', fileName);
}

// Export modal functions (for compatibility)
function openExportModal() {
    console.log('üìÑ Opening export modal...');
    // For Excel page, directly download instead of showing modal
    directExcelDownload();
}

function closeExportModal() {
    console.log('üö™ Closing export modal...');
    const modal = document.getElementById('export-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function exportToExcel() {
    console.log('üì§ Excel export triggered from modal...');
    
    // Get date range from current filter inputs (not modal)
    const startDate = document.getElementById('customer-start-date')?.value || '';
    const endDate = document.getElementById('customer-end-date')?.value || '';
    
    let downloadUrl = '/customer-dashboard/excel/?';
    let fileName = 'Health_Check_Tracker_Export';
    
    // Add parameters
    const params = new URLSearchParams({
        download: 'true',
        format: 'xlsx'
    });
    
    if (startDate && endDate) {
        params.append('start_date', startDate);
        params.append('end_date', endDate);
        fileName += `_filtered_${startDate}_to_${endDate}`;
    }
    
    downloadUrl += params.toString();
    fileName += '.xlsx';
    
    console.log('üì§ Modal export URL:', downloadUrl);
    
    // Trigger download directly
    window.location.href = downloadUrl;
    
    // Close modal if it exists
    setTimeout(() => {
        closeExportModal();
    }, 500);
    
    console.log('‚úÖ Modal Excel export completed:', fileName);
}

// DYNAMIC CHART RESIZE HANDLER
function handleChartResize() {
    // Debounce resize events
    clearTimeout(window.chartResizeTimeout);
    window.chartResizeTimeout = setTimeout(() => {
        console.log('üîÑ Adjusting charts for window resize...');
        
        // Update charts with current data if available
        if (window.customersExcelData) {
            updateGraphsWithRealData(window.customersExcelData);
        }
    }, 300);
}

// Add resize listener for responsive charts
window.addEventListener('resize', handleChartResize);

// Auto load on page ready
window.addEventListener('load', function() {
    setTimeout(loadExcelData, 2000);
});

console.log('‚úÖ Clean script loaded successfully with dynamic responsive charts');
</script>
{% endblock %}
