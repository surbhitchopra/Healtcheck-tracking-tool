{% extends 'base.html' %}

{% block title %} 1830 PSS Health Checking History Tracking Tool {% endblock %}

{% block extra_head %}
{%load static %}
  <style>
    @font-face {
     font-family: nokiaUlt;
      src: url('../static/assets/fonts/NokiaPureHeadline_Lt.woff');
    }
    
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      background-attachment: fixed;
      min-height: 100vh;
      font-family: nokiaUlt;
      position: relative;
    }
    
    /* Professional gradient overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(16, 185, 129, 0.04) 0%, transparent 50%);
      pointer-events: none;
      z-index: -10;
    }
    
    /* Professional glass effect */
    .glass-effect {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(226, 232, 240, 0.6);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.06), 
                  0 4px 12px rgba(0, 0, 0, 0.04),
                  inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    
    /* Enhanced animations */
    .fade-in {
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      transform: translateY(30px);
    }
    .fade-in.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Professional card styling */
    .step-card {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
      backdrop-filter: blur(20px);
      border: 1px solid rgba(203, 213, 225, 0.4);
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.08),
        0 8px 25px rgba(0, 0, 0, 0.04),
        0 2px 8px rgba(0, 0, 0, 0.02),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .step-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
    }
    .step-card:hover {
      transform: translateY(-8px);
      box-shadow: 
        0 35px 70px rgba(0, 0, 0, 0.12),
        0 15px 35px rgba(0, 0, 0, 0.06),
        0 5px 15px rgba(0, 0, 0, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 0.95);
      border-color: rgba(59, 130, 246, 0.2);
    }
    
    /* More compact step indicators */
    .step-number {
      background: linear-gradient(135deg, #1e40af, #3b82f6, #60a5fa);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      box-shadow: 
        0 3px 8px rgba(59, 130, 246, 0.3),
        0 1px 4px rgba(59, 130, 246, 0.2);
      position: relative;
    }
    
    /* Professional buttons */
    .upload-btn {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 8px 25px rgba(59, 130, 246, 0.25),
        0 3px 10px rgba(59, 130, 246, 0.15);
      position: relative;
      overflow: hidden;
    }
    .upload-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    .upload-btn:hover::before {
      left: 100%;
    }
    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 15px 35px rgba(59, 130, 246, 0.3),
        0 5px 20px rgba(59, 130, 246, 0.2);
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
    }
    
    /* Professional file items */
    .file-item {
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 15px;
      margin: 12px 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.04);
      position: relative;
    }
    .file-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      border-radius: 16px 0 0 16px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .file-item:hover {
      transform: translateX(8px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
      border-color: #3b82f6;
    }
    .file-item:hover::before {
      opacity: 1;
    }
    
    /* Professional status badges */
    .status-badge {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Professional loading animation */
    .animate-pulse-slow {
      animation: professional-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes professional-pulse {
      0%, 100% { 
        opacity: 1;
        transform: scale(1);
      }
      50% { 
        opacity: 0.7;
        transform: scale(0.98);
      }
    }
    
    /* Enhanced header styling */
    .header-gradient {
      background: linear-gradient(135deg, #1e293b, #334155);
      color: white;
      border-radius: 16px;
      position: relative;
      overflow: hidden;
    }
    .header-gradient::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }
    
    .success-gradient {
      background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .action-btn {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 8px;
      color: white;
      transition: all 0.3s ease;
    }
    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      background: linear-gradient(135deg, #4b5563, #374151);
    }
    
    /* Enhanced sidebar styling */
    #sticky-sidebar {
      background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(226, 232, 240, 0.6);
      box-shadow: 
        -25px 0 50px rgba(0, 0, 0, 0.08),
        -8px 0 25px rgba(0, 0, 0, 0.04);
      transition: transform 0.3s ease-in-out;
    }
    
    /* Professional info cards */
    .info-card {
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      border: 1px solid rgba(226, 232, 240, 0.6);
      border-radius: 20px;
      padding: 24px;
      margin: 16px;
      box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.06),
        0 5px 15px rgba(0, 0, 0, 0.04);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .info-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa, #34d399);
      border-radius: 20px 20px 0 0;
    }
    .info-card:hover {
      transform: scale(1.02);
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.1),
        0 10px 25px rgba(0, 0, 0, 0.06);
    }
    
    /* Professional icon styling */
    .icon-badge {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .icon-badge::after {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.2));
      z-index: -1;
    }
    
    /* Professional toggle button */
    #sidebar-toggle {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 999;
    }
    #sidebar-toggle:hover {
      transform: translateY(-50%) translateX(-4px) scale(1.05);
    }
    .toggle-button {
      background: linear-gradient(135deg, #3b82f6, #1e40af);
      border-radius: 16px 0 0 16px;
      box-shadow: 
        0 15px 35px rgba(59, 130, 246, 0.3),
        0 5px 15px rgba(59, 130, 246, 0.2);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .toggle-button:hover {
      box-shadow: 
        0 20px 45px rgba(59, 130, 246, 0.4),
        0 8px 20px rgba(59, 130, 246, 0.25);
    }
    
    /* Enhanced typography */
    h1 {
      font-weight: 800;
      color: white;
    }
    h2 {
      font-weight: 700;
      color: #1e293b;
    }
    
    /* Responsive enhancements */
    @media (max-width: 1024px) {
      .step-card {
        margin: 16px 8px;
      }
    }
    @media (max-width: 768px) {
      .step-number {
        width: 48px;
        height: 48px;
        font-size: 18px;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex">
  <!-- Main Content Area -->
  <div class="flex-1 py-1 px-4 pr-72"> <!-- Reduced top padding -->
    <div class="w-full max-w-4xl space-y-5 mx-auto">
    <!-- Title -->
    <div class="bg-white p-3 rounded-lg shadow-sm border border-blue-100 text-center mt-1">
      <h1 class="text-lg font-bold text-blue-800 mb-1">1830 PSS Health Checking History Tracking Tool</h1>
      <p class="text-blue-600 text-xs">Process and Track Reports Efficiently</p>
    </div>

    <!-- Django Messages Display -->
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'success' or 'success' in message.tags %}
                <!-- Green Success Message Box - Same styling as temperature dashboard -->
                <div class="step-card p-8 rounded-2xl border-2 border-green-200">
                  <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center mr-4">
                      <span class="text-white font-bold text-xl">‚úì</span>
                    </div>
                    <div>
                      <h2 class="text-xl font-bold text-gray-800 mb-1">Success!</h2>
                      <p class="text-gray-600 text-sm">Health check processing completed</p>
                    </div>
                  </div>
                  <div class="text-center bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 p-6 rounded-xl mb-6">
                    <div class="text-green-700 font-semibold text-lg">
                        {% if 'safe' in message.tags %}
                            {{ message|safe }}
                        {% else %}
                            {{ message }}
                        {% endif %}
                    </div>
                  </div>
                </div>
            {% elif message.tags == 'error' or 'error' in message.tags %}
                <!-- Red Error Message Box -->
                <div class="step-card p-8 rounded-2xl border-2 border-red-200">
                  <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-full flex items-center justify-center mr-4">
                      <span class="text-white font-bold text-xl">‚úó</span>
                    </div>
                    <div>
                      <h2 class="text-xl font-bold text-gray-800 mb-1">Error</h2>
                      <p class="text-gray-600 text-sm">Something went wrong</p>
                    </div>
                  </div>
                  <div class="text-center bg-gradient-to-r from-red-50 to-red-50 border border-red-200 p-6 rounded-xl mb-6">
                    <div class="text-red-700 font-semibold text-lg">
                        {% if 'safe' in message.tags %}
                            {{ message|safe }}
                        {% else %}
                            {{ message }}
                        {% endif %}
                    </div>
                  </div>
                </div>
            {% else %}
                <!-- Default Message Box -->
                <div class="step-card p-8 rounded-2xl border-2 border-blue-200">
                  <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mr-4">
                      <span class="text-white font-bold text-xl">i</span>
                    </div>
                    <div>
                      <h2 class="text-xl font-bold text-gray-800 mb-1">Information</h2>
                      <p class="text-gray-600 text-sm">System message</p>
                    </div>
                  </div>
                  <div class="text-center bg-gradient-to-r from-blue-50 to-blue-50 border border-blue-200 p-6 rounded-xl mb-6">
                    <div class="text-blue-700 font-semibold text-lg">
                        {% if 'safe' in message.tags %}
                            {{ message|safe }}
                        {% else %}
                            {{ message }}
                        {% endif %}
                    </div>
                  </div>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <div id="tracker-message" class="hidden p-4 rounded-xl text-center text-white font-medium"></div>


    <!-- Step 1: TEC Upload -->
    <div id="step1" class="fade-in visible step-card p-2 rounded-lg {% if messages %}hidden{% endif %}">
      <div class="flex items-center justify-between mb-1.5">
        <div class="flex items-center">
          <div class="step-number mr-2">1</div>
          <div>
            <h2 class="text-sm font-bold text-gray-800 mb-0.5">Upload Health Check Files <span class="text-xs font-normal text-blue-600">(File name "{{ selected_customer.name }}{% if selected_customer.network_name %} {{ selected_customer.network_name }}{% endif %}")</span></h2>
            <p class="text-gray-600 text-xs">Upload files based on network setup status <a href="https://de711tec001.nice.nokia.net/tec/bin/hcGetDetails.cgi?hcBase=1830&cmd=hcRprt&disp=list" target="_blank" class="text-blue-600 underline hover:text-blue-800 ml-2">Need Health Check Report?</a></p>
          </div>
        </div>
        
        <!-- Change Customer Button - Extra Small Size -->
        <div class="ml-2 flex space-x-1">
          <a href="{% url 'customer_selection' %}" 
             class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-2 py-1 rounded font-medium text-xs transition-all duration-300 shadow-sm hover:shadow-md transform hover:-translate-y-0.5 flex items-center">
            <span>Change Customer</span>
          </a>
        </div>
      </div>
      
      
      {% if selected_customer.setup_status == 'NEW' %}
        <!-- NEW NETWORK SETUP (5 files) -->
        
        <form id="health-check-form" action="{% url 'dashboard' %}" method="post" enctype="multipart/form-data" class="space-y-2">
          {% csrf_token %}
          
          <!-- Row 1: HC Tracker File & Global Ignore Text -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 items-start">
            <!-- HC Tracker File -->
            <div class="bg-gray-50 border border-gray-200 rounded p-2 h-auto">
              <label class="block mb-1 text-xs font-semibold text-gray-700">1. Upload HC Tracker File</label>
              <input type="file" id="hc-tracker" name="hc_tracker_file" accept=".xlsx" required class="w-full p-1.5 rounded border border-gray-300 bg-white hover:border-blue-400 transition-colors text-xs file:mr-2 file:py-0.5 file:px-1.5 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              <div id="hc-tracker-validation" class="hidden mt-1 p-1.5 rounded text-xs max-h-16 overflow-y-auto"></div>
            </div>
            
            <!-- Global Ignore Text -->
            <div class="bg-gray-50 border border-gray-200 rounded p-2 h-auto">
              <label class="block mb-1 text-xs font-semibold text-gray-700">2. Upload Global Ignore Text File</label>
              <input type="file" id="global-ignore" name="global_ignore_txt" accept=".txt" required class="w-full p-1.5 rounded border border-gray-300 bg-white hover:border-blue-400 transition-colors text-xs file:mr-2 file:py-0.5 file:px-1.5 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              <div id="global-ignore-validation" class="hidden mt-1 p-1.5 rounded text-xs max-h-16 overflow-y-auto"></div>
            </div>
          </div>
          
          <!-- Row 2: Selective Ignore Excel, TEC Report & Inventory CSV -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 items-start">
            <!-- Selective Ignore Excel -->
            <div class="bg-gray-50 border border-gray-200 rounded p-2 h-auto">
              <label class="block mb-1 text-xs font-semibold text-gray-700">3. Upload Selective Ignore Excel File</label>
              <input type="file" id="selective-ignore" name="selective_ignore_xlsx" accept=".xlsx" required class="w-full p-1.5 rounded border border-gray-300 bg-white hover:border-blue-400 transition-colors text-xs file:mr-2 file:py-0.5 file:px-1.5 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              <div id="selective-ignore-validation" class="hidden mt-1 p-1.5 rounded text-xs max-h-16 overflow-y-auto"></div>
            </div>
            
            <!-- TEC Report -->
            <div class="bg-gray-50 border border-gray-200 rounded p-2 h-auto">
              <label class="block mb-1 text-xs font-semibold text-gray-700">4. Upload TEC Health Check Report</label>
              <input type="file" id="tec-report" name="tec_report_file" accept=".xlsx" required class="w-full p-1.5 rounded border border-gray-300 bg-white hover:border-blue-400 transition-colors text-xs file:mr-2 file:py-0.5 file:px-1.5 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              <div id="tec-filename-validation" class="hidden mt-1 p-1.5 rounded text-xs max-h-16 overflow-y-auto"></div>
            </div>
            
            <!-- Remote Inventory CSV -->
            <div class="bg-gray-50 border border-gray-200 rounded p-2 h-auto">
              <label class="block mb-1 text-xs font-semibold text-gray-700">5. Upload Remote Inventory CSV File</label>
              <input type="file" id="inventory-csv" name="inventory_csv" accept=".csv" required class="w-full p-1.5 rounded border border-gray-300 bg-white hover:border-blue-400 transition-colors text-xs file:mr-2 file:py-0.5 file:px-1.5 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              <div id="csv-filename-validation" class="hidden mt-1 p-1.5 rounded text-xs max-h-16 overflow-y-auto"></div>
            </div>
          </div>
          
          <div class="flex justify-center">
            <button type="submit" id="upload-submit-btn" class="upload-btn px-4 py-1.5 text-white rounded text-sm font-medium hover:shadow-lg transition-all flex items-center justify-center gap-1">
              <span class="spinner hidden w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"></span>
              <span class="text-xs">Proceed</span>
            </button>
          </div>
        </form>
        
      {% else %}
        <!-- EXISTING NETWORK (2 files) -->
        
        
        <form id="health-check-form" action="{% url 'dashboard' %}" method="post" enctype="multipart/form-data" class="space-y-3">
          {% csrf_token %}
          
          <!-- Row 1: TEC Report and Inventory CSV in compact grid layout -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 items-start">
            <!-- TEC Report -->
            <div class="bg-gray-50 border border-gray-200 rounded p-2 h-auto">
              <label class="block mb-1 text-xs font-semibold text-gray-700">1. Upload TEC Health Check Report</label>
              <input type="file" id="tec-report" name="tec_report_file" accept=".xlsx" required class="w-full p-1.5 rounded border border-gray-300 bg-white hover:border-blue-400 transition-colors text-xs file:mr-2 file:py-0.5 file:px-1.5 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            <div id="tec-filename-validation" class="hidden mt-1 p-1.5 rounded text-xs max-h-16 overflow-y-auto"></div>
            </div>
            
            <!-- Inventory CSV -->
            <div class="bg-gray-50 border border-gray-200 rounded p-2 h-auto">
              <label class="block mb-1 text-xs font-semibold text-gray-700">2. Upload Remote Inventory CSV File</label>
              <input type="file" id="inventory-csv" name="inventory_csv" accept=".csv" required class="w-full p-1.5 rounded border border-gray-300 bg-white hover:border-blue-400 transition-colors text-xs file:mr-2 file:py-0.5 file:px-1.5 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              <div id="csv-filename-validation" class="hidden mt-1 p-1.5 rounded text-xs max-h-16 overflow-y-auto"></div>
            </div>
          </div>
          
          <div class="flex justify-center">
            <button type="submit" id="upload-submit-btn" class="upload-btn px-4 py-1.5 text-white rounded text-sm font-medium hover:shadow-lg transition-all flex items-center justify-center gap-1">
              <span class="spinner hidden w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"></span>
              <span class="text-xs">Proceed</span>
            </button>
          </div>
        </form>
        
      {% endif %}
      <div id="tec-stdout" class="mt-4 hidden bg-gray-100 text-sm p-4 rounded-lg text-gray-800 whitespace-pre-wrap"></div>
      <div id="tec-stderr" class="mt-2 hidden bg-red-100 text-sm p-4 rounded-lg text-red-700 whitespace-pre-wrap"></div>
    </div>

    <!--Step 2:

 Host Upload -->
    <div id="step2-host" class="fade-in hidden step-card p-8 rounded-2xl">
      <div class="flex items-center mb-6">
        <div class="step-number mr-4">2</div>
        <div>
          <h2 class="text-xl font-bold text-gray-800 mb-1">Upload Host File</h2>
          <p class="text-gray-600 text-sm">Upload your host configuration file to create tracker</p>
        </div>
      </div>
      <form id="host-form" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        <div>
          <label class="block mb-3 text-base font-semibold text-gray-700">Upload Current Host File</label>
          <input type="file" id="host-file" accept=".xlsx,.csv" class="w-2/3 p-4 rounded-xl border-2 border-gray-200 bg-gray-50 hover:border-blue-400 transition-colors duration-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-base file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
          <div id="host-filename-validation" class="hidden mt-3 p-3 rounded-xl text-base"></div>
        </div>
        <button type="submit" id="host-submit-btn" class="upload-btn w-full py-4 text-white rounded-xl font-semibold hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-3">
          <span class="spinner hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
          <span class="text-xl"> Submit Host File</span>
        </button>
      </form>
    </div>

    <!-- Step 3: Download -->
    <div id="step3" class="fade-in hidden step-card p-8 rounded-2xl border-2 border-green-200">
      <div class="flex items-center mb-6">
        <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center mr-4">
          <span class="text-white font-bold text-xl">‚úì</span>
        </div>
        <div>
          <h2 class="text-xl font-bold text-gray-800 mb-1">Download Tracker File</h2>
          <p class="text-gray-600 text-sm">Your tracker file has been generated successfully</p>
        </div>
      </div>
      <div class="text-center bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 p-6 rounded-xl mb-6">
        <p class="text-green-700 font-semibold text-lg">Tracker file generated successfully!</p>
      </div>
      <div class="text-center">
        <a id="download-link" href="#" class="success-gradient inline-block px-8 py-4 text-white rounded-xl hover:shadow-lg transition-all duration-300 font-semibold text-lg">
          üì• Download Tracker File
        </a>
      </div>
    </div>

    <!-- Step 4: Tracker History - Compact -->
    <div id="step5-history" class="fade-in visible step-card p-1.5 rounded-xl mt-6">
      <div class="flex items-center mb-1">
        <div class="w-5 h-5 bg-gradient-to-r from-gray-600 to-gray-800 rounded flex items-center justify-center mr-1.5">
          <span class="text-white font-bold text-xs">üìä</span>
        </div>
        <div>
          <h2 class="text-sm font-bold text-gray-800 mb-0">Customer History</h2>
          <p class="text-gray-600 text-xs">Files & trackers</p>
        </div>
      </div>
      
      <!-- Customer Folder - Compact -->
      <div class="mb-1">
        <div class="flex items-center justify-between glass-effect p-1.5 rounded border border-gray-200">
          <div class="flex items-center">
            <span class="text-sm mr-1.5">üìÅ</span>
            <div>
              <span class="font-medium text-gray-800 text-xs">{{ selected_customer.name }}{% if selected_customer.network_name %} - {{ selected_customer.network_name }}{% endif %}</span>
              <p class="text-gray-500 text-xs">Management</p>
            </div>
          </div>
          <div class="text-right">
            <span id="file-count" class="text-xs font-medium text-blue-600">Loading...</span>
          </div>
        </div>
      </div>
      
      <!-- Compact history without scrollbar -->
      <div class="bg-gray-50 rounded border border-gray-200">
        <div id="history-list" class="space-y-0.5 p-2">
          <p class="text-gray-600 text-xs">Fetching history...</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toggle Button for Sidebar - Vertical Tab -->
  <div id="sidebar-toggle" class="fixed right-0 top-2/3 transform -translate-y-1/2 z-50 cursor-pointer">
    <div class="bg-gradient-to-b from-blue-400 to-blue-500 rounded-l-lg shadow-lg px-3 py-5 hover:shadow-xl transition-all duration-300 hover:px-4">
      <div class="flex flex-col items-center text-white">
        <span id="toggle-icon" class="text-base mb-2">üë§</span>
        <div class="transform -rotate-90 whitespace-nowrap text-xs font-bold tracking-wider">
          <span id="toggle-text">Info</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Enhanced Right Sidebar with App Boxes -->
  <div id="sticky-sidebar" class="fixed right-0 top-0 h-full w-72 bg-gradient-to-b from-slate-50 to-slate-100 shadow-xl border-l border-slate-300 pt-8 px-3 pb-8 transform translate-x-0 transition-transform duration-300 ease-in-out">
    <!-- Optimized content container - fill more space -->
    <div class="h-full flex flex-col justify-start space-y-6 pt-16">
      
      <!-- Current Customer App Box -->
      <div class="bg-white rounded-lg shadow-md border border-blue-200 p-4 hover:shadow-lg transition-all duration-200 hover:scale-[1.01]">
        <div class="flex items-center mb-3">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
            <span class="text-white text-base font-bold">üë§</span>
          </div>
          <div class="flex-1">
            <h4 class="font-bold text-slate-800 text-sm uppercase tracking-wide">Customer</h4>
            <p class="text-xs text-slate-500">Active</p>
          </div>
        </div>
        <div id="sticky-customer" class="text-sm font-bold text-blue-800 mb-2 truncate">{{ selected_customer.name }}</div>
        <div id="sticky-customer-time" class="text-xs text-slate-600 bg-blue-50 px-2 py-1 rounded text-center">Loading...</div>
      </div>
      
      <!-- Latest Tracker App Box -->
      <div class="bg-white rounded-lg shadow-md border border-emerald-200 p-4 hover:shadow-lg transition-all duration-200 hover:scale-[1.01]">
        <div class="flex items-center mb-3">
          <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center mr-3">
            <span class="text-white text-base font-bold">üìä</span>
          </div>
          <div class="flex-1">
            <h4 class="font-bold text-slate-800 text-sm uppercase tracking-wide">Tracker</h4>
            <p class="text-xs text-slate-500">Latest</p>
          </div>
        </div>
        <div id="sticky-tracker" class="text-sm font-bold text-emerald-800 mb-2 truncate">Loading...</div>
        <div id="sticky-tracker-details" class="text-xs text-slate-600 bg-emerald-50 px-2 py-1 rounded text-center">Loading...</div>
      </div>
      
      <!-- Recent Activity App Box -->
      <div class="bg-white rounded-lg shadow-md border border-purple-200 p-4 hover:shadow-lg transition-all duration-200 hover:scale-[1.01]">
        <div class="flex items-center mb-3">
          <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
            <span class="text-white text-base font-bold">‚ö°</span>
          </div>
          <div class="flex-1">
            <h4 class="font-bold text-slate-800 text-sm uppercase tracking-wide">Activity</h4>
            <p class="text-xs text-slate-500">Recent</p>
          </div>
        </div>
        <div id="sticky-activity" class="text-sm font-semibold text-purple-800 mb-2 truncate">Loading...</div>
        <div id="sticky-activity-details" class="text-xs text-slate-600 bg-purple-50 px-2 py-1 rounded text-center">Loading...</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const step1 = document.getElementById('step1');
    const step2Host = document.getElementById('step2-host');
    const step3 = document.getElementById('step3');
    const downloadLink = document.getElementById('download-link');
    const trackerMsg = document.getElementById('tracker-message');
    
    let previousThreshold = null; // Store previous threshold value
    
    // Function to check for previous threshold and show warning
    async function checkPreviousThreshold() {
      const currentThreshold = document.getElementById('threshold').value;
      const warningDiv = document.getElementById('threshold-warning');
      
      // Only show warning if user has entered a value and we have a previous threshold
      if (currentThreshold && previousThreshold && currentThreshold != previousThreshold) {
        warningDiv.innerHTML = `
          <strong>‚ö†Ô∏è Temperature Threshold Changed:</strong><br>
          Previous threshold was <strong>${previousThreshold}¬∞C</strong><br>
          You are now entering <strong>${currentThreshold}¬∞C</strong><br>
          <span class="text-xs">This will update the temperature analysis in your tracker.</span>
        `;
        warningDiv.classList.remove('hidden');
      } else if (currentThreshold && previousThreshold && currentThreshold == previousThreshold) {
        warningDiv.innerHTML = `
          <strong>‚úÖ Same threshold:</strong> Using previous threshold <strong>${previousThreshold}¬∞C</strong>
        `;
        warningDiv.classList.remove('hidden');
      } else {
        warningDiv.classList.add('hidden');
      }
    }
    
    // Function to fetch and set previous threshold (disabled - no API endpoint)
    async function fetchPreviousThreshold() {
      // Disabled - API endpoint doesn't exist
      console.log('üìä Previous threshold API disabled - no endpoint available');
      return;
    }
    
    // Function to refresh temperature threshold (call when customer changes)
    async function refreshTemperatureThreshold() {
      try {
        console.log('üîÑ Refreshing temperature threshold...');
        const thresholdInput = document.getElementById('threshold');
        
        // Clear current value
        previousThreshold = null;
        if (thresholdInput) {
          thresholdInput.value = '';
        }
        
        // Fetch fresh threshold data
        await fetchPreviousThreshold();
        
        // If still no threshold, try to get from sticky notes
        if (!previousThreshold) {
          await updateStickyNotes();
        }
        
        console.log('‚úÖ Temperature threshold refresh complete');
      } catch (err) {
        console.error('‚ùå Error refreshing temperature threshold:', err);
      }
    }
    
    // Function to update temperature threshold after successful generation
    function updateTemperatureAfterGeneration(temperature) {
      try {
        const usedThreshold = parseFloat(temperature);
        if (!isNaN(usedThreshold)) {
          previousThreshold = usedThreshold;
          const thresholdInput = document.getElementById('threshold');
          if (thresholdInput) {
            thresholdInput.value = usedThreshold;
          }
          console.log('üå°Ô∏è Updated temperature threshold after generation:', usedThreshold + '¬∞C');
          
          // Show brief confirmation
          const warningDiv = document.getElementById('threshold-warning');
          if (warningDiv) {
            warningDiv.innerHTML = `
              <strong>‚úÖ Updated:</strong> Temperature threshold set to <strong>${usedThreshold}¬∞C</strong> for next upload
            `;
            warningDiv.className = 'mb-3 p-3 rounded-lg text-sm bg-green-100 border border-green-200 text-green-800';
            warningDiv.classList.remove('hidden');
            
            // Hide after 3 seconds
            setTimeout(() => {
              warningDiv.classList.add('hidden');
            }, 3000);
          }
        }
      } catch (err) {
        console.error('‚ùå Error updating temperature after generation:', err);
      }
    }
    
    // Function to update sticky notes
    async function updateStickyNotes() {
      try {
        const response = await fetch(`{% url 'sticky_notes_data' %}`, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
          }
        });
        
        const data = await response.json();
        if (data.status === 'success') {
          // Update current customer info
          if (data.current_customer) {
            document.getElementById('sticky-customer').textContent = data.current_customer.name;
            document.getElementById('sticky-customer-time').textContent = data.current_customer.selected_time;
          }
          
          // Update last tracker info
          if (data.last_tracker) {
            document.getElementById('sticky-tracker').textContent = data.last_tracker.filename;
            document.getElementById('sticky-tracker-details').textContent = `Customer: ${data.last_tracker.customer} - ${data.last_tracker.timestamp}`;
          } else {
            document.getElementById('sticky-tracker').textContent = 'No tracker yet';
            document.getElementById('sticky-tracker-details').textContent = 'Upload files to generate';
          }
          
          // Update last activity
          if (data.last_activity) {
            document.getElementById('sticky-activity').textContent = data.last_activity.action;
            document.getElementById('sticky-activity-details').textContent = `${data.last_activity.customer} - ${data.last_activity.timestamp}`;
          } else {
            document.getElementById('sticky-activity').textContent = 'No activity yet';
            document.getElementById('sticky-activity-details').textContent = 'Start by uploading files';
          }
          
          return;
        }
      } catch (err) {
        console.error('Error updating sticky notes:', err);
      }
      
      // Set fallback values with current customer info and real-time timestamp
      document.getElementById('sticky-customer').textContent = '{{ selected_customer.name }}';
      // Use consistent time formatting to match backend exactly: DD/MM/YYYY HH:MM AM/PM
      const now = new Date();
      const istTime = now.toLocaleString('en-GB', {
        timeZone: 'Asia/Kolkata',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      }).replace(/,\s*/, ' '); // Remove comma and extra spaces between date and time
      document.getElementById('sticky-customer-time').textContent = istTime;
      document.getElementById('sticky-tracker').textContent = 'No tracker yet';
      document.getElementById('sticky-tracker-details').textContent = 'Upload files to generate';
      document.getElementById('sticky-activity').textContent = 'No activity yet';
      document.getElementById('sticky-activity-details').textContent = 'Start by uploading files';
    }

    function showMessage(msg, bgColor) {
      trackerMsg.className = `p-4 rounded-xl text-center text-white font-medium mb-4 ${bgColor}`;
      trackerMsg.textContent = msg;
      trackerMsg.classList.remove('hidden');
      setTimeout(() => trackerMsg.classList.add('hidden'), 5000);
    }

    // Handle form submission for health check upload (using existing views)
    document.getElementById('health-check-form').addEventListener('submit', function(e) {
      const btn = document.getElementById('upload-submit-btn');
      const spinner = btn.querySelector('.spinner');
      
      // Show loading state
      btn.disabled = true;
      spinner.classList.remove('hidden');
      
      showMessage('üì§ Uploading files for processing...', 'bg-blue-600');
      
      // Let the form submit normally to the existing view
      // The view will handle the processing and redirect appropriately
    });
    
    // Check for URL parameters to show processing or results
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session');
    if (sessionId) {
      // If we have a session ID, we might be returning from processing
      showMessage('‚úÖ Processing complete! Check the results.', 'bg-green-600');
    }

    document.getElementById('host-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const hostFile = document.getElementById('host-file').files[0];
      const btn = document.getElementById('host-submit-btn');
      const spinner = btn.querySelector('.spinner');

      if (!hostFile) return alert('Please upload the Host file.');

      const formData = new FormData();
      formData.append('host_file', hostFile);

      btn.disabled = true;
      spinner.classList.remove('hidden');

      try {
        const response = await fetch("/upload-host/", {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: formData
        });

        const data = await response.json();
        if (data.status === 'success' && data.file_url) {
          downloadLink.href = data.file_url;
          showMessage('‚úÖ Host uploaded. Tracker file generated.', 'bg-blue-600');
          step2Host.classList.add('hidden');
          step3.classList.remove('hidden');
          step3.classList.add('visible');
          
          // Update file count immediately if available
          if (data.file_count !== undefined) {
            document.getElementById('file-count').textContent = `${data.file_count} file${data.file_count !== 1 ? 's' : ''}`;
          }
          // Refresh tracker history to show new files
          setTimeout(() => {
            fetchTrackerHistory();
            updateStickyNotes(); // Update sticky notes after successful host upload
          }, 1000); // Small delay to ensure file is saved
        } else if (data.status === 'error') {
          showMessage(`‚ùå ${data.message}`, 'bg-red-600');
          // Still refresh history in case of partial success
          fetchTrackerHistory();
        } else {
          showMessage('‚ö†Ô∏è Host upload processed but no tracker file generated.', 'bg-yellow-600');
          fetchTrackerHistory();
        }

      } catch (err) {
        console.error(err);
        showMessage('‚ùå Failed to upload host file.', 'bg-red-600');
      } finally {
        spinner.classList.add('hidden');
        btn.disabled = false;
      }
    });


    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    async function cleanupDatabase() {
      try {
        showMessage('‚ùå Cleanup feature not available in current setup.', 'bg-red-600');
        return;
        
        const response = await fetch("/cleanup-database/", {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
          }
        });

        const data = await response.json();
        if (data.status === 'success') {
          showMessage(`‚úÖ Cleanup successful. ${data.cleaned_count} records processed.`, 'bg-green-600');
          fetchTrackerHistory(); // Sync history after cleanup
        } else {
          showMessage(`‚ùå Cleanup failed: ${data.message}`, 'bg-red-600');
        }
      } catch (err) {
        console.error('Error during cleanup:', err);
        showMessage('‚ùå Error during cleanup.', 'bg-red-600');
      }
    }

    async function fetchTrackerHistory() {
      try {
        // Add cache-busting parameter to force fresh data
        const timestamp = new Date().getTime();
        console.log('üîÑ Fetching tracker history with timestamp:', timestamp);
        
        const response = await fetch(`{% url 'tracker_history' %}?t=${timestamp}&cb=${Math.random()}`, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken'),
            'Cache-Control': 'no-cache, no-store, must-revalidate, max-age=0',
            'Pragma': 'no-cache',
            'Expires': '0'
          },
          cache: 'no-store'
        });
        
          const data = await response.json();
          console.log('Tracker history data:', data); // Debug log
          const historyList = document.getElementById('history-list');
          
          // Excel customer handling removed
          
          if (data.status === 'success' && data.customer_folders && data.customer_folders.length > 0) {
          const customerFolders = data.customer_folders;
          const selectedCustomerId = data.selected_customer_id;
          
          // Update file count using server-provided total for selected customer
          const fileCount = document.getElementById('file-count');
          const selectedCustomerFiles = data.selected_customer_files || 0;
          fileCount.textContent = `${selectedCustomerFiles} file${selectedCustomerFiles !== 1 ? 's' : ''} for ${data.selected_customer_name}`;
          
          
          // Clear existing content
          historyList.innerHTML = '';
          
          // Create folders for each customer
          customerFolders.forEach((customerFolder, index) => {
            const isSelected = customerFolder.customer_id === selectedCustomerId;
            const folders = customerFolder.folders;
            
            // Create customer folder section
            const customerSection = document.createElement('div');
            customerSection.className = 'mb-4';
            
            const customerHeader = document.createElement('div');
            customerHeader.className = `flex items-center border-l-4 p-2 mb-2 cursor-pointer hover:bg-blue-100 transition ${
              isSelected ? 'bg-blue-50 border-blue-400' : 'bg-gray-50 border-gray-300'
            }`;
            customerHeader.innerHTML = `
              <span class="text-blue-600 mr-2 transition-transform duration-200" id="customer-arrow-${index}">‚ñ∂</span>
              <span class="text-blue-600 mr-2">üìÇ</span>
              <span class="font-medium ${isSelected ? 'text-blue-700' : 'text-gray-700'}">${customerFolder.customer_name}</span>
              <span class="text-xs ${isSelected ? 'text-blue-600' : 'text-gray-500'} ml-2">${isSelected ? ' - Current' : ''}</span>
            `;
            
            const customerFilesList = document.createElement('div');
            customerFilesList.className = 'space-y-2 pl-4 hidden';
            customerFilesList.id = `customer-files-list-${index}`;
            
            // Add click handler for customer folder
            customerHeader.addEventListener('click', () => {
              const arrow = document.getElementById(`customer-arrow-${index}`);
              if (customerFilesList.classList.contains('hidden')) {
                customerFilesList.classList.remove('hidden');
                arrow.style.transform = 'rotate(90deg)';
                arrow.innerHTML = '‚ñº';
              } else {
                customerFilesList.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
                arrow.innerHTML = '‚ñ∂';
              }
            });
            
            // Create subfolders with temperature dashboard SVG icons
            const subfolders = [
              { 
                name: 'Host Files', 
                key: 'host_files', 
                icon: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <rect x="3" y="4" width="18" height="12" rx="2" fill="#e2e8f0"/>
                  <rect x="3" y="4" width="18" height="3" rx="2" fill="#64748b"/>
                  <circle cx="6" cy="7" r="0.5" fill="#ef4444"/>
                  <circle cx="8" cy="7" r="0.5" fill="#f59e0b"/>
                  <circle cx="10" cy="7" r="0.5" fill="#10b981"/>
                  <rect x="6" y="10" width="12" height="1" fill="#94a3b8"/>
                  <rect x="6" y="12" width="8" height="1" fill="#cbd5e1"/>
                </svg>`, 
                color: 'text-green-600' 
              },
              { 
                name: 'Reports', 
                key: 'reports', 
                icon: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <rect x="4" y="3" width="16" height="18" rx="2" fill="#dbeafe"/>
                  <rect x="4" y="3" width="16" height="4" fill="#3b82f6"/>
                  <rect x="7" y="5" width="10" height="1" fill="white"/>
                  <rect x="7" y="6.5" width="6" height="0.5" fill="white"/>
                  <rect x="6" y="10" width="4" height="6" fill="#60a5fa"/>
                  <rect x="11" y="12" width="4" height="4" fill="#93c5fd"/>
                  <rect x="16" y="9" width="2" height="7" fill="#1d4ed8"/>
                </svg>`, 
                color: 'text-blue-600' 
              },
              { 
                name: 'Inventory', 
                key: 'inventory_files', 
                icon: 'üì¶', 
                color: 'text-indigo-600' 
              },
              { 
                name: 'Tracker Generated', 
                key: 'tracker_generated', 
                icon: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <rect x="3" y="3" width="18" height="18" rx="2" fill="#dcfce7"/>
                  <path d="M8 12l2 2 4-4" stroke="#16a34a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="12" cy="12" r="8" stroke="#22c55e" stroke-width="1" fill="none"/>
                  <rect x="6" y="6" width="2" height="2" fill="#4ade80"/>
                  <rect x="16" y="6" width="2" height="2" fill="#4ade80"/>
                  <rect x="6" y="16" width="2" height="2" fill="#4ade80"/>
                  <rect x="16" y="16" width="2" height="2" fill="#4ade80"/>
                </svg>`, 
                color: 'text-purple-600' 
              },
              { 
                name: 'Old Trackers', 
                key: 'old_trackers', 
                icon: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <rect x="6" y="2" width="12" height="16" rx="1" fill="#fef3c7"/>
                  <rect x="6" y="2" width="12" height="3" fill="#f59e0b"/>
                  <rect x="8" y="3.5" width="8" height="0.5" fill="white"/>
                  <rect x="8" y="7" width="8" height="1" fill="#d97706"/>
                  <rect x="8" y="9" width="6" height="0.5" fill="#ed8936"/>
                  <rect x="8" y="11" width="4" height="0.5" fill="#f6ad55"/>
                  <path d="M12 15l-2 3h4l-2-3z" fill="#f59e0b"/>
                  <circle cx="12" cy="20" r="2" fill="#92400e"/>
                </svg>`, 
                color: 'text-orange-600' 
              }
            ];
            
            subfolders.forEach((subfolder, subIndex) => {
              const files = folders[subfolder.key] || [];
              console.log(`üìÅ ${customerFolder.customer_name} - ${subfolder.name}: ${files.length} files`);
              if (subfolder.key === 'old_trackers') {
                console.log('üü† OLD TRACKERS DEBUG:', files);
              }
              // Always show all folders regardless of file count
              if (true) {
                // Subfolder header
                const subfolderHeader = document.createElement('div');
                subfolderHeader.className = 'flex items-center p-2 bg-gray-50 border border-gray-200 rounded cursor-pointer hover:bg-gray-100 transition';
                subfolderHeader.innerHTML = `
                  <span class="text-gray-600 mr-2 transition-transform duration-200" id="subfolder-arrow-${index}-${subIndex}">‚ñ∂</span>
                  <span class="${subfolder.color} mr-2">${subfolder.icon}</span>
                  <span class="font-medium text-gray-700">${subfolder.name}</span>
                  <span class="text-xs text-gray-500 ml-2">(${files.length})</span>
                `;
                
                const subfolderFilesList = document.createElement('div');
                subfolderFilesList.className = 'space-y-1 pl-6 mt-1 hidden';
                subfolderFilesList.id = `subfolder-files-list-${index}-${subIndex}`;
                
                // Add click handler for subfolder
                subfolderHeader.addEventListener('click', (e) => {
                  e.stopPropagation();
                  const arrow = document.getElementById(`subfolder-arrow-${index}-${subIndex}`);
                  if (subfolderFilesList.classList.contains('hidden')) {
                    subfolderFilesList.classList.remove('hidden');
                    arrow.style.transform = 'rotate(90deg)';
                    arrow.innerHTML = '‚ñº';
                  } else {
                    subfolderFilesList.classList.add('hidden');
                    arrow.style.transform = 'rotate(0deg)';
                    arrow.innerHTML = '‚ñ∂';
                  }
                });
                
                // Add files to subfolder
                if (files.length > 0) {
                  files.forEach(file => {
                    const fileEl = document.createElement('div');
                    fileEl.className = 'flex justify-between items-center bg-white border border-gray-100 px-3 py-2 rounded hover:bg-gray-50 transition';
                    
                    const thresholdInfo = file.threshold ? `(${file.threshold}¬∞C)` : '';
                    const statusColor = file.status === 'Success' ? 'text-green-600' : file.status === 'Processing' ? 'text-yellow-600' : 'text-red-600';
                    const fileName = file.filename || '';
                    const fileStatus = file.status || '';
                    const fileDate = file.upload_date || file.generated_at || '';
                    
                    // Special handling for old trackers - emphasize temperature
                    const isOldTracker = subfolder.key === 'old_trackers';
                    const temperatureDisplay = isOldTracker && file.threshold ? 
                      `<span class="text-sm font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded">${file.threshold}¬∞C</span>` : 
                      `<span class="text-xs text-blue-600 ml-2">${thresholdInfo}</span>`;
                    
                    fileEl.innerHTML = `
                      <div class="flex-1">
                        <div class="flex items-center">
                          <span class="text-gray-600 mr-2">üìÑ</span>
                          <span class="font-medium text-gray-800 text-sm">${fileName}</span>
                          ${temperatureDisplay}
                          <span class="text-xs ${statusColor} ml-2">${fileStatus}</span>
                        </div>
                        <div class="text-xs text-gray-500 ml-4">
                          ${fileDate}
                        </div>
                      </div>
                      <div class="flex gap-1">
                        ${file.file_url ? `<a href="${file.file_url}" download class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition flex items-center" title="Download ${fileName}">‚¨áÔ∏è</a>` : ''}
                        ${isOldTracker ? `<button onclick="showUploadOldTracker()" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition flex items-center" title="Upload Another Old Tracker">üì§</button>` : ''}
                        ${subfolder.key === 'host_files' ? `<button onclick="triggerHostUpload()" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition flex items-center" title="Upload Another Host File">üì§</button>` : ''}
                        ${subfolder.key === 'reports' ? `<button onclick="triggerTecUpload()" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition flex items-center" title="Upload Another Report">üì§</button>` : ''}
                        ${subfolder.key === 'inventory_files' ? `<button onclick="triggerInventoryUpload()" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition flex items-center" title="Upload Another Inventory File">üì§</button>` : ''}
                        ${subfolder.key === 'tracker_generated' ? `<button onclick="triggerTrackerUpload()" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition flex items-center" title="Upload Tracker File">üì§</button>` : ''}
                        ${file.upload_id ? `<button onclick="deleteTrackerFile(${file.upload_id}, '${fileName}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition flex items-center" title="Delete ${fileName}">üóëÔ∏è</button>` : ''}
                      </div>
                    `;
                    subfolderFilesList.appendChild(fileEl);
                  });
                }
                
                // Old tracker upload form removed - now using small upload button beside download
                
                if (files.length === 0) {
                  // Show empty folder message with upload functionality
                  const emptyMsg = document.createElement('div');
                  emptyMsg.className = 'text-center py-4 text-gray-400 text-sm';
                  
                  if (subfolder.key === 'old_trackers') {
                    // Add all three actions for empty old trackers folder (same as when files exist)
                    emptyMsg.innerHTML = `
                      <div class="space-y-3">
                        <div class="italic">
                          <span class="text-gray-300">üìÇ</span> No ${subfolder.name.toLowerCase()} uploaded yet
                        </div>
                        <div class="flex justify-center gap-1">
                          <button onclick="showDownloadOldTracker()" 
                                  class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Download Old Tracker">‚¨áÔ∏è</button>
                          <button onclick="showUploadOldTracker()" 
                                  class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Upload Old Tracker">üì§</button>
                          <button onclick="showDeleteOldTracker()" 
                                  class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Delete Old Tracker">üóëÔ∏è</button>
                        </div>
                      </div>
                    `;
                  } else if (subfolder.key === 'host_files') {
                    // Add all three actions for empty host files folder (same as when files exist)
                    emptyMsg.innerHTML = `
                      <div class="space-y-3">
                        <div class="italic">
                          <span class="text-gray-300">üìÇ</span> No ${subfolder.name.toLowerCase()} uploaded yet
                        </div>
                        <div class="flex justify-center gap-1">
                          <button onclick="showDownloadHostFile()" 
                                  class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Download Host File">‚¨áÔ∏è</button>
                          <button onclick="triggerHostUpload()" 
                                  class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Upload Host File">üì§</button>
                          <button onclick="showDeleteHostFile()" 
                                  class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Delete Host File">üóëÔ∏è</button>
                        </div>
                      </div>
                    `;
                  } else if (subfolder.key === 'reports') {
                    // Add all three actions for empty reports folder (same as when files exist)
                    emptyMsg.innerHTML = `
                      <div class="space-y-3">
                        <div class="italic">
                          <span class="text-gray-300">üìÇ</span> No ${subfolder.name.toLowerCase()} uploaded yet
                        </div>
                        <div class="flex justify-center gap-1">
                          <button onclick="showDownloadReport()" 
                                  class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Download Report">‚¨áÔ∏è</button>
                          <button onclick="triggerTecUpload()" 
                                  class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Upload Report">üì§</button>
                          <button onclick="showDeleteReport()" 
                                  class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Delete Report">üóëÔ∏è</button>
                        </div>
                      </div>
                    `;
                  } else if (subfolder.key === 'inventory_files') {
                    // Add all three actions for empty inventory folder
                    emptyMsg.innerHTML = `
                      <div class="space-y-3">
                        <div class="italic">
                          <span class="text-gray-300">üìÇ</span> No ${subfolder.name.toLowerCase()} uploaded yet
                        </div>
                        <div class="flex justify-center gap-1">
                          <button onclick="showDownloadInventory()" 
                                  class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Download Inventory">‚¨áÔ∏è</button>
                          <button onclick="triggerInventoryUpload()" 
                                  class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Upload Inventory">üì§</button>
                          <button onclick="showDeleteInventory()" 
                                  class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Delete Inventory">üóëÔ∏è</button>
                        </div>
                      </div>
                    `;
                  } else {
                    // Add actions for tracker_generated folder
                    emptyMsg.innerHTML = `
                      <div class="space-y-3">
                        <div class="italic">
                          <span class="text-gray-300">üìÇ</span> No ${subfolder.name.toLowerCase()} uploaded yet
                        </div>
                        <div class="flex justify-center gap-1">
                          <button onclick="showDownloadTrackerGenerated()" 
                                  class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Download Tracker">‚¨áÔ∏è</button>
                          <button onclick="triggerTrackerUpload()" 
                                  class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Upload Tracker">üì§</button>
                          <button onclick="showDeleteTrackerGenerated()" 
                                  class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition flex items-center" 
                                  title="Delete Tracker">üóëÔ∏è</button>
                        </div>
                      </div>
                    `;
                  }
                  
                  subfolderFilesList.appendChild(emptyMsg);
                }
                
                customerFilesList.appendChild(subfolderHeader);
                customerFilesList.appendChild(subfolderFilesList);
              }
            });
            
            customerSection.appendChild(customerHeader);
            customerSection.appendChild(customerFilesList);
            historyList.appendChild(customerSection);
          });
        } else {
          // Update file count to 0
          const fileCount = document.getElementById('file-count');
          fileCount.textContent = '0 tracker files for ' + data.selected_customer_name;
          
          historyList.innerHTML = `<p class="text-gray-500">No tracker history found for this customer.</p>`;
          
          // Automatically trigger workflow reset
          setTimeout(() => {
            checkAndShowHostUpload();
          }, 100);
        }
      } catch (err) {
        console.error("Failed to fetch tracker history:", err);
        document.getElementById('history-list').innerHTML = `<p class="text-red-500">Failed to load history.</p>`;
      }
    }
    
    // Real-time filename validation
    async function validateFilename(filename, validationElementId, fileType = '', uploadSection = '') {
      if (!filename) {
        document.getElementById(validationElementId).classList.add('hidden');
        return;
      }
      
      try {
        const response = await fetch(`{% url 'validate_filename' %}?filename=${encodeURIComponent(filename)}&expected_type=${fileType}&upload_section=${uploadSection}`, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
          }
        });
        
        const data = await response.json();
        const validationEl = document.getElementById(validationElementId);
        
        if (data.status === 'success') {
          validationEl.classList.remove('hidden');
          if (data.is_valid) {
            validationEl.className = 'mt-2 p-2 rounded text-xs overflow-y-auto transition-all duration-300 bg-green-100 border border-green-200 text-green-700';
            validationEl.innerHTML = '‚úÖ ' + data.message;
          } else {
            validationEl.className = 'mt-2 p-2 rounded text-xs overflow-y-auto transition-all duration-300 bg-red-100 border border-red-200 text-red-700';
            // Shorten the error message to show only the first meaningful line
            const shortMessage = data.message.split('\n')[0].replace(/‚ùå|üö´|\*\*/g, '').trim();
            validationEl.innerHTML = '‚ùå ' + shortMessage;
          }
        }
      } catch (err) {
        console.error('Error validating filename:', err);
      }
    }
    
    // Add event listeners for file inputs with proper validation parameters
    document.getElementById('tec-report').addEventListener('change', function(e) {
      const filename = e.target.files[0]?.name || '';
      validateFilename(filename, 'tec-filename-validation', 'REPORT', 'report_upload');
    });
    
    const hostFileInput = document.getElementById('host-file');
    if (hostFileInput) {
      hostFileInput.addEventListener('change', function(e) {
        const filename = e.target.files[0]?.name || '';
        validateFilename(filename, 'host-filename-validation', 'HOST', 'host_upload');
      });
    }
    
    const csvInput = document.getElementById('inventory-csv');
    if (csvInput) {
      csvInput.addEventListener('change', function(e) {
        const filename = e.target.files[0]?.name || '';
        validateFilename(filename, 'csv-filename-validation', 'INVENTORY', 'inventory_upload');
      });
    }
    
    // Add validation for new network files
    const hcTrackerInput = document.getElementById('hc-tracker');
    if (hcTrackerInput) {
      hcTrackerInput.addEventListener('change', function(e) {
        const filename = e.target.files[0]?.name || '';
        validateFilename(filename, 'hc-tracker-validation', 'TRACKER', 'tracker_upload');
      });
    }
    
    const globalIgnoreInput = document.getElementById('global-ignore');
    if (globalIgnoreInput) {
      globalIgnoreInput.addEventListener('change', function(e) {
        const filename = e.target.files[0]?.name || '';
        validateFilename(filename, 'global-ignore-validation', 'IGNORE', 'ignore_upload');
      });
    }
    
    const selectiveIgnoreInput = document.getElementById('selective-ignore');
    if (selectiveIgnoreInput) {
      selectiveIgnoreInput.addEventListener('change', function(e) {
        const filename = e.target.files[0]?.name || '';
        validateFilename(filename, 'selective-ignore-validation', 'IGNORE', 'ignore_upload');
      });
    }
    
    
      // Delete tracker file function
      async function deleteTrackerFile(uploadId, fileName) {
        if (!confirm(`Are you sure you want to delete tracker file '${fileName}'?`)) {
          return;
        }
        
        try {
          const formData = new FormData();
          formData.append('upload_id', uploadId);
          
          showMessage(`üóëÔ∏è Deleting file '${fileName}'...`, 'bg-yellow-600');
          
          const response = await fetch("{% url 'delete_tracker' %}", {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: formData
        })

        document.getElementById('tec-stdout').classList.add("hidden");
        document.getElementById('tec-stderr').classList.add("hidden");
        
        const data = await response.json();
        if (data.status === 'success') {
          showMessage(`‚úÖ ${data.message}`, 'bg-green-600');
          
          // Clear existing history immediately for instant feedback
          const historyList = document.getElementById('history-list');
          historyList.innerHTML = '<p class="text-gray-600">Refreshing history...</p>';
          
          // If workflow restart is needed, show TEC upload form
          if (data.workflow_restart_needed) {
            // Hide all steps first
            step1.classList.remove('hidden');
            step2Host.classList.add('hidden');
            step3.classList.add('hidden');
            
            // Show TEC upload step
            step1.classList.add('visible');
            
            setTimeout(() => {
              showMessage('üîÑ Complete cleanup successful! All files removed. Ready to upload report and Host file again.', 'bg-blue-500');
            }, 1000);
          }
          
          // Add delay to ensure database deletion is committed
          setTimeout(async () => {
            await fetchTrackerHistory();
            checkAndShowHostUpload();
          }, 800); // Increased delay to ensure database consistency

          // Update sticky notes before reloading to ensure it shows correct tracker status
          await updateStickyNotes();
          
          // Wait a moment to ensure sticky notes update is visible
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } 
        
      } catch (err) {
        console.error('Error deleting tracker file:', err);
        showMessage('‚ùå Error deleting tracker file.', 'bg-red-600');
      }
    }
    
    // Check if host upload should be shown
    function checkAndShowHostUpload() {
      // If no tracker files exist, show the host upload step
      setTimeout(() => {
        const historyList = document.getElementById('history-list');
        const trackerFilesList = document.getElementById('tracker-files-list');
        const bulkActions = document.getElementById('bulk-actions');
        
        // Check if there are no tracker files or the message shows no history
        const hasNoTrackers = historyList.innerHTML.includes('No tracker history found') || 
                             (trackerFilesList && trackerFilesList.children.length === 0) ||
                             historyList.textContent.includes('No tracker history found');
        
        if (hasNoTrackers) {
          // Hide all steps first
          step1.classList.add('hidden');
          step2Host.classList.add('hidden');
          step3.classList.add('hidden');
          
          // Show TEC upload step first (since we need TEC report before host)
          step1.classList.remove('hidden');
          step1.classList.add('visible');
          
          showMessage('‚ö†Ô∏è No tracker files found. Please upload  report first, then Host file to generate tracker.', 'bg-yellow-500');
        }
      }, 500);
    }
    
    
    // Toggle sidebar visibility
    let sidebarOpen = true;
    
    function toggleSidebar() {
      const sidebar = document.getElementById('sticky-sidebar');
      const toggleButton = document.getElementById('sidebar-toggle');
      const toggleIcon = document.getElementById('toggle-icon');
      const toggleText = document.getElementById('toggle-text');
      const mainContent = document.querySelector('.flex-1');
      
      if (sidebarOpen) {
        // Close sidebar
        sidebar.classList.add('translate-x-full');
        toggleIcon.textContent = 'üë§'; // Person icon when closed
        toggleText.textContent = 'INFO'; // Short text when closed
        mainContent.classList.remove('pr-80');
        mainContent.classList.add('pr-4');
        sidebarOpen = false;
      } else {
        // Open sidebar
        sidebar.classList.remove('translate-x-full');
        toggleIcon.textContent = '√ó'; // X icon when open
        toggleText.textContent = 'HIDE'; // Short text when open
        mainContent.classList.remove('pr-4');
        mainContent.classList.add('pr-80');
        sidebarOpen = true;
      }
    }
    
    // Load tracker history when page loads
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Dashboard: Initializing temperature threshold...');
      
      // Set temperature threshold - prioritize last used over default
      const thresholdInput = document.getElementById('threshold');
      {% if last_temperature %}
      const lastUsedTemperature = {{ last_temperature }};
      console.log('üå°Ô∏è Frontend: Received last_temperature from Django:', lastUsedTemperature);
      if (thresholdInput && lastUsedTemperature) {
        thresholdInput.value = lastUsedTemperature;
        console.log('‚úÖ Frontend: Set temperature input to:', lastUsedTemperature + '¬∞C');
        
        // Set as previous threshold for comparison (this will be used for warnings)
        previousThreshold = lastUsedTemperature;
        
        // Show subtle notification about auto-population
        const warningDiv = document.getElementById('threshold-warning');
        if (warningDiv) {
          warningDiv.innerHTML = `
            <strong>‚ÑπÔ∏è Auto-populated:</strong> Using last temperature <strong>${lastUsedTemperature}¬∞C</strong> from previous upload
          `;
          warningDiv.className = 'mb-3 p-3 rounded-lg text-sm bg-blue-100 border border-blue-200 text-blue-800';
          warningDiv.classList.remove('hidden');
          
          // Hide the notification after 5 seconds
          setTimeout(() => {
            warningDiv.classList.add('hidden');
          }, 5000);
        }
      }
      {% else %}
      // Fall back to customer default if no last temperature
      const customerDefaultThreshold = {{ selected_customer.default_threshold|default:30 }};
      console.log('‚ö†Ô∏è Frontend: No last_temperature, using customer default:', customerDefaultThreshold);
      if (thresholdInput && customerDefaultThreshold) {
        thresholdInput.value = customerDefaultThreshold;
        console.log('‚úÖ Frontend: Set temperature input to customer default:', customerDefaultThreshold + '¬∞C');
        
        // Show notification about using default
        const warningDiv = document.getElementById('threshold-warning');
        if (warningDiv) {
          warningDiv.innerHTML = `
            <strong>üè≠ Using default:</strong> Customer default temperature <strong>${customerDefaultThreshold}¬∞C</strong>
          `;
          warningDiv.className = 'mb-3 p-3 rounded-lg text-sm bg-gray-100 border border-gray-200 text-gray-800';
          warningDiv.classList.remove('hidden');
          
          // Hide the notification after 3 seconds
          setTimeout(() => {
            warningDiv.classList.add('hidden');
          }, 3000);
        }
      }
      {% endif %}
      
      // Load data in sequence with error handling
      try {
        await fetchPreviousThreshold(); // Load previous threshold first
        await updateStickyNotes(); // Load sticky notes data
        await fetchTrackerHistory();
        
        // Final check: ensure threshold is set
        const thresholdInput = document.getElementById('threshold');
        if (thresholdInput && !thresholdInput.value) {
          console.log('‚ö†Ô∏è Final check: No threshold set, using fallback');
          thresholdInput.value = '30'; // Fallback
        }
        
        console.log('‚úÖ Dashboard initialization complete');
      } catch (err) {
        console.error('‚ùå Error during dashboard initialization:', err);
      }
      
      // Check initial state and adjust workflow if needed
      setTimeout(() => {
        checkAndShowHostUpload();
      }, 200);
      
      // Add click event to toggle button
      document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
    });
  function showUploadOldTracker() {
    console.log('showUploadOldTracker called');
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.xlsx';
    input.style.display = 'none';
    input.onchange = async function(event) {
        console.log('File selected:', event.target.files[0]);
        const file = event.target.files[0];
        if (!file) {
            console.log('No file selected');
            return alert('Please select a file to upload.');
        }
        
        console.log('File name:', file.name);
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            console.log('Invalid file type');
            return alert('‚ùå Please upload an Excel (.xlsx) file.');
        }
        
        console.log('Starting upload...');
        showMessage('üì§ Uploading old tracker...', 'bg-blue-600');
        
        const formData = new FormData();
        formData.append('old_tracker_file', file);
        
        try {
            console.log('Sending request to /upload-old-tracker/');
            const response = await fetch("{% url 'upload_old_tracker_file' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
            
            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.status === 'success') {
                showMessage(`‚úÖ ${data.message}`, 'bg-green-600');
                setTimeout(() => {
                    fetchTrackerHistory();
                    updateStickyNotes();
                }, 1000);
            } else {
                showMessage(`‚ùå ${data.message}`, 'bg-red-600');
            }
        } catch (err) {
            console.error('Upload error:', err);
            showMessage('‚ùå Error uploading old tracker file.', 'bg-red-600');
        }
    };
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
  }
  
  // Function to trigger Host file upload from empty folder - SIMPLIFIED
  function triggerHostUpload() {
    console.log('triggerHostUpload called - SIMPLIFIED VERSION');
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.xlsx,.csv';
    input.style.display = 'none';
    input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) {
            return; // Just exit silently if no file
        }
        
        console.log('File selected:', file.name);
        showMessage('üì§ Uploading host file...', 'bg-blue-600');
        
        const formData = new FormData();
        formData.append('host_file', file);
        
        try {
            console.log('Making upload request...');
            const response = await fetch("/upload-host/", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
            
            console.log('Response received:', response.status);
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.status === 'success') {
                showMessage('‚úÖ Host file uploaded successfully!', 'bg-green-600');
                setTimeout(() => {
                    fetchTrackerHistory();
                    updateStickyNotes();
                }, 1000);
            } else {
                showMessage(`‚ùå Upload failed: ${data.message || 'Unknown error'}`, 'bg-red-600');
            }
        } catch (err) {
            console.error('Upload error:', err);
            showMessage('‚ùå Network error during upload.', 'bg-red-600');
        }
    };
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
  }
  
  // Function to trigger TEC report upload from empty folder
  function triggerTecUpload() {
    console.log('triggerTecUpload called');
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.xlsx';
    input.style.display = 'none';
    input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) {
            return alert('Please select a file to upload.');
        }
        
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            return alert('‚ùå Please upload an Excel (.xlsx) file.');
        }
        
        // First, perform full validation using the validation API
        const customerName = '{{ selected_customer.name }}';
        
        // Show loading message
        showMessage('üîÑ Validating file...', 'bg-blue-600');
        
        try {
            const validateResponse = await fetch(`{% url 'validate_filename' %}?filename=${encodeURIComponent(file.name)}&expected_type=REPORT&upload_section=report_upload`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const validateData = await validateResponse.json();
            
            if (validateData.status === 'success' && !validateData.is_valid) {
                return alert(`‚ùå File validation failed:\n\n${validateData.message}`);
            }
            
            if (validateData.status !== 'success') {
                return alert(`‚ùå Validation error: ${validateData.message || 'Unknown error'}`);
            }
            
        } catch (err) {
            console.error('Validation error:', err);
            return alert('‚ùå Error validating file. Please try again.');
        }
        
        showMessage('üì§ Uploading TEC Health Check Report...', 'bg-blue-600');
        
        // Create simple FormData for dedicated report upload
        const formData = new FormData();
        formData.append('tec_report_file', file);
        
        try {
            console.log('Sending to upload_report_file endpoint...');
            
            // Use the dedicated report upload endpoint
            const response = await fetch("{% url 'upload_report_file' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
            
            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.status === 'success') {
                showMessage(`‚úÖ ${data.message}`, 'bg-green-600');
                
                // Update folders
                setTimeout(() => {
                    fetchTrackerHistory();
                    updateStickyNotes();
                }, 1000);
                
            } else {
                showMessage(`‚ùå ${data.message}`, 'bg-red-600');
            }
            
        } catch (err) {
            console.error('Upload error:', err);
            showMessage('‚ùå Error uploading TEC Health Check Report.', 'bg-red-600');
        }
    };
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
  }
  
  // Download functions for empty folders
  function showDownloadOldTracker() {
    showMessage('‚ö†Ô∏è No old tracker files available to download. Upload a file first.', 'bg-yellow-600');
  }
  
  function showDownloadHostFile() {
    showMessage('‚ö†Ô∏è No host files available to download. Upload a file first.', 'bg-yellow-600');
  }
  
  function showDownloadReport() {
    showMessage('‚ö†Ô∏è No report files available to download. Upload a file first.', 'bg-yellow-600');
  }
  
  // Delete functions for empty folders
  function showDeleteOldTracker() {
    showMessage('‚ö†Ô∏è No old tracker files available to delete. Folder is already empty.', 'bg-yellow-600');
  }
  
  function showDeleteHostFile() {
    showMessage('‚ö†Ô∏è No host files available to delete. Folder is already empty.', 'bg-yellow-600');
  }
  
  function showDeleteReport() {
    showMessage('‚ö†Ô∏è No report files available to delete. Folder is already empty.', 'bg-yellow-600');
  }
  
  // Inventory folder functions
  function showDownloadInventory() {
    showMessage('‚ö†Ô∏è No inventory files available to download. Upload a file first.', 'bg-yellow-600');
  }
  
  function showDeleteInventory() {
    showMessage('‚ö†Ô∏è No inventory files available to delete. Folder is already empty.', 'bg-yellow-600');
  }
  
  function triggerInventoryUpload() {
    console.log('triggerInventoryUpload called');
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.style.display = 'none';
    input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) {
            return alert('Please select a file to upload.');
        }
        
        if (!file.name.toLowerCase().endsWith('.csv')) {
            return alert('‚ùå Please upload a CSV (.csv) file.');
        }
        
        // First, perform full validation using the validation API
        const customerName = '{{ selected_customer.name }}';
        
        // Show loading message
        showMessage('üîÑ Validating file...', 'bg-indigo-600');
        
        try {
            const validateResponse = await fetch(`{% url 'validate_filename' %}?filename=${encodeURIComponent(file.name)}&expected_type=INVENTORY&upload_section=inventory_upload`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const validateData = await validateResponse.json();
            
            if (validateData.status === 'success' && !validateData.is_valid) {
                return alert(`‚ùå File validation failed:\n\n${validateData.message}`);
            }
            
            if (validateData.status !== 'success') {
                return alert(`‚ùå Validation error: ${validateData.message || 'Unknown error'}`);
            }
            
        } catch (err) {
            console.error('Validation error:', err);
            return alert('‚ùå Error validating file. Please try again.');
        }
        
        showMessage('üì§ Uploading Inventory CSV File...', 'bg-indigo-600');
        
        // Create simple FormData for dedicated inventory upload
        const formData = new FormData();
        formData.append('inventory_file', file);  // Use correct field name
        
        try {
            console.log('Sending to upload_inventory_file endpoint...');
            
            // Use the dedicated inventory upload endpoint
            const response = await fetch("{% url 'upload_inventory_file' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
            
            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.status === 'success') {
                showMessage(`‚úÖ ${data.message}`, 'bg-green-600');
                
                // Update folders
                setTimeout(() => {
                    fetchTrackerHistory();
                    updateStickyNotes();
                }, 1000);
                
            } else {
                showMessage(`‚ùå ${data.message}`, 'bg-red-600');
            }
            
        } catch (err) {
            console.error('Upload error:', err);
            showMessage('‚ùå Error uploading inventory file.', 'bg-red-600');
        }
    };
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
  }
  
  // Functions for tracker generated section
  function showDownloadTrackerGenerated() {
    showMessage('‚ö†Ô∏è No tracker files available to download. Upload Report and Host file to generate tracker first.', 'bg-yellow-600');
  }
  
  function showDeleteTrackerGenerated() {
    showMessage('‚ö†Ô∏è No tracker files available to delete. Folder is already empty.', 'bg-yellow-600');
  }
  
  // Function to trigger direct Tracker upload to Tracker Generated section
  function triggerTrackerUpload() {
    console.log('triggerTrackerUpload called');
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.xlsx';
    input.style.display = 'none';
    input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) {
            return alert('Please select a file to upload.');
        }
        
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            return alert('‚ùå Please upload an Excel (.xlsx) file.');
        }
        
        // Check if filename contains tracker indicators
        const filename = file.name.toLowerCase();
        if (!filename.includes('tracker') && !filename.includes('temp')) {
            return alert('‚ùå Please upload a TRACKER file. File should contain "tracker" or "temp" in name.');
        }
        
        showMessage('üì§ Uploading tracker file...', 'bg-green-600');
        
          const formData = new FormData();
          formData.append('tracker_generated_file', file);
          
          try {
          const response = await fetch("{% url 'upload_tracker_generated_file' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                showMessage('‚úÖ Tracker file uploaded successfully!', 'bg-green-600');
                setTimeout(() => {
                    fetchTrackerHistory();
                    updateStickyNotes();
                }, 1000);
            } else {
                showMessage(`‚ùå ${data.message}`, 'bg-red-600');
                setTimeout(() => {
                    fetchTrackerHistory();
                }, 1000);
            }
        } catch (err) {
            console.error('Upload error:', err);
            showMessage('‚ùå Error uploading tracker file.', 'bg-red-600');
        }
    };
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
  }
  
  // Function to fix OLD_TRACKER temperatures - removed
  
  // Function to load real tracker data with lifecycle management
  function loadRealTrackerData() {
    console.log('üîç Starting to load tracker data...');
    
    Promise.all([
      // Try to load old_tracker.json
      fetch('old_tracker.json').then(r => r.json()).catch(() => {
        console.log('‚ùå Could not load old_tracker.json from root');
        return {};
      }),
      // Try to load tracker_generated.json  
      fetch('tracker_generated.json').then(r => r.json()).catch(() => {
        console.log('‚ùå Could not load tracker_generated.json from root');
        return {};
      })
    ])
    .then(([oldTrackers, generatedTrackers]) => {
      console.log('‚úÖ Loaded old tracker data:', oldTrackers);
      console.log('‚úÖ Loaded generated tracker data:', generatedTrackers);
      
      // Clear existing history to rebuild properly
      tempHistory = [];
      
      // Process tracker lifecycle:
      // 1. Add old trackers as "previous"
      Object.entries(oldTrackers).forEach(([key, tracker]) => {
        if (tracker.temperature && tracker.name) {
          const trackerData = {
            name: tracker.name,
            temperature: tracker.temperature,
            date: tracker.last_updated || new Date().toLocaleString(),
            id: key + '_old',
            status: 'old' // Mark as old/previous
          };
          tempHistory.push(trackerData);
          console.log(`üìÅ Added old tracker: ${tracker.name} - ${tracker.temperature}`);
        }
      });
      
      // 2. Add generated trackers as "current"
      Object.entries(generatedTrackers).forEach(([key, tracker]) => {
        if (tracker.temperature && tracker.name) {
          const trackerData = {
            name: tracker.name,
            temperature: tracker.temperature,
            date: tracker.last_updated || new Date().toLocaleString(),
            id: key + '_current',
            status: 'current' // Mark as current/active
          };
          tempHistory.push(trackerData);
          console.log(`üå°Ô∏è Added current tracker: ${tracker.name} - ${tracker.temperature}`);
        }
      });
      
      console.log('üìä Total trackers loaded:', tempHistory.length);
      console.log('üìä Tracker history:', tempHistory);
      
      // Sort by status (old first, then current)
      tempHistory.sort((a, b) => {
        if (a.status === 'old' && b.status === 'current') return -1;
        if (a.status === 'current' && b.status === 'old') return 1;
        return 0;
      });
      
      // Update the display
      updatePreviousTrackerTemp();
    })
    .catch(error => {
      console.log('‚ùå Could not load tracker data:', error);
      // Try to get from the sticky notes API instead
      loadFromStickyNotesAPI();
    });
  }
  
  // Function to load from sticky notes API
  function loadFromStickyNotesAPI() {
    // Disabled - no sticky notes endpoint available
    console.log('üìä Sticky notes API not available');
    return;
    
    fetch(`/sticky-notes-data/`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        console.log('Loading from sticky notes API:', data);
        
        // Add previous tracker if available
        if (data.previous_tracker && data.previous_tracker.threshold) {
          const trackerData = {
            name: data.previous_tracker.filename || 'Previous Tracker',
            filename: data.previous_tracker.filename, // Include filename for customer name extraction
            temperature: data.previous_tracker.threshold,
            date: data.previous_tracker.timestamp || new Date().toLocaleString(),
            id: 'previous',
            status: 'old'
          };
          tempHistory.push(trackerData);
        }
        
        // Add current tracker if available
        if (data.last_tracker && data.last_tracker.threshold) {
          const trackerData = {
            name: data.last_tracker.filename || 'Current Tracker',
            filename: data.last_tracker.filename, // Include filename for customer name extraction
            temperature: data.last_tracker.threshold,
            date: data.last_tracker.timestamp || new Date().toLocaleString(),
            id: 'current',
            status: 'current'
          };
          tempHistory.push(trackerData);
        }
        
        updatePreviousTrackerTemp();
      }
    })
    .catch(error => {
      console.log('Could not load from API:', error);
    });
  }
  
  // Function to add new tracker when generated
  function addNewTrackerData(trackerInfo) {
    const trackerData = {
      name: trackerInfo.filename || trackerInfo.name || 'New Tracker',
      filename: trackerInfo.filename,
      temperature: trackerInfo.threshold || trackerInfo.temperature,
      date: trackerInfo.timestamp || new Date().toLocaleString(),
      id: trackerInfo.id || Date.now().toString(),
      status: trackerInfo.status || 'current'
    };
    
    // Check if this tracker is not already in history
    const exists = tempHistory.find(t => t.id === trackerData.id);
    if (!exists) {
      tempHistory.push(trackerData);
      console.log(`üå°Ô∏è Added new tracker: ${trackerData.name} - ${trackerData.temperature} (${trackerData.status})`);
    }
  }
  
  // Function to manually refresh temperature data
  function refreshTemperatureCard() {
    console.log('üîÑ Manually refreshing temperature card...');
    
    // Call the sticky notes update which will trigger temperature update
    updateStickyNotes();
    
    // Also try to reload from files
    setTimeout(() => {
      loadRealTrackerData();
    }, 500);
  }
  
  // Helper function to check for TEC report file
  async function checkForTecReportFile() {
    console.log('üîç Checking for available TEC report file...');
    try {
      // Check if we have the tracker history data
      const response = await fetch(`{% url 'tracker_history' %}`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      const data = await response.json();
      if (data.status === 'success' && data.customer_folders) {
        const selectedCustomerFolder = data.customer_folders.find(f => f.customer_id === data.selected_customer_id);
        if (selectedCustomerFolder && selectedCustomerFolder.folders.reports && selectedCustomerFolder.folders.reports.length > 0) {
          console.log('üìä Found TEC report file available');
          return selectedCustomerFolder.folders.reports[0]; // Return first available report
        }
      }
      
      console.log('üìä No TEC report file found');
      return null;
    } catch (err) {
      console.error('Error checking for TEC report file:', err);
      return null;
    }
  }
  
  // Helper function to check for inventory file
  async function checkForInventoryFile() {
    console.log('üîç Checking for available inventory file...');
    try {
      // Check if we have the tracker history data
      const response = await fetch(`{% url 'tracker_history' %}`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      const data = await response.json();
      if (data.status === 'success' && data.customer_folders) {
        const selectedCustomerFolder = data.customer_folders.find(f => f.customer_id === data.selected_customer_id);
        if (selectedCustomerFolder && selectedCustomerFolder.folders.inventory_files && selectedCustomerFolder.folders.inventory_files.length > 0) {
          console.log('üì¶ Found inventory file available');
          return selectedCustomerFolder.folders.inventory_files[0]; // Return first available inventory
        }
      }
      
      console.log('üì¶ No inventory file found');
      return null;
    } catch (err) {
      console.error('Error checking for inventory file:', err);
      return null;
    }
  }
  
  // Helper function to get tracker history data (reusable)
  async function getTrackerHistoryData() {
    console.log('üîç Getting tracker history data...');
    try {
      const response = await fetch(`{% url 'tracker_history' %}`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      const data = await response.json();
      if (data.status === 'success') {
        console.log('‚úÖ Successfully retrieved tracker history data');
        return data;
      }
      
      console.log('‚ùå Failed to get tracker history data');
      return null;
    } catch (err) {
      console.error('Error getting tracker history data:', err);
      return null;
    }
  }
  
  // Hook into existing tracker generation functions
  // Modify the existing updateStickyNotes function to also update temperature
  const originalUpdateStickyNotes = updateStickyNotes;
  updateStickyNotes = async function() {
    await originalUpdateStickyNotes();
    
    // Check if we have new tracker data and extract temperature
    try {
      console.log('üìä Sticky notes API disabled - no endpoint available');
      return;
      
      const response = await fetch(`/sticky-notes-data/`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      const data = await response.json();
      if (data.status === 'success') {
        console.log('üîÑ Updating temperature card with new data:', data);
        
        // Clear existing history to rebuild with fresh data
        tempHistory = [];
        
        // Check previous tracker temperature
        if (data.previous_tracker && data.previous_tracker.threshold) {
          addNewTrackerData({
            filename: data.previous_tracker.filename,
            name: data.previous_tracker.filename || 'Previous Tracker',
            threshold: data.previous_tracker.threshold,
            timestamp: data.previous_tracker.timestamp,
            id: 'previous',
            status: 'old'
          });
        }
        
        // Check if latest tracker has temperature info
        if (data.last_tracker && data.last_tracker.threshold) {
          addNewTrackerData({
            filename: data.last_tracker.filename,
            name: data.last_tracker.filename || 'Current Tracker',
            threshold: data.last_tracker.threshold,
            timestamp: data.last_tracker.timestamp,
            id: 'current',
            status: 'current'
          });
        }
        
        // Force update the display
        setTimeout(() => {
        }, 200); // Small delay to ensure sticky notes are updated first
      }
    } catch (err) {
      console.log('Could not extract temperature from tracker data');
    }
  };
  
  
</script>
{% endblock %}
