// üìä COMPLETE FIX FOR EXPORT DATES ISSUE
// This ensures all dates appear properly in Excel export

console.log('üìä Loading EXPORT DATES FIX...');

// üìä FIXED EXPORT FUNCTION WITH PROPER DATES
window.exportToExcelFixed = async function() {
    console.log('üìä FIXED EXPORT: Starting with proper date extraction...');
    
    try {
        const csrfToken = getCsrfToken();
        if (!csrfToken) {
            throw new Error('No CSRF token found');
        }
        
        // Show loading
        showNotification('üìä Generating Excel with all dates...', 'info');
        
        // Get date filters
        const startDate = document.getElementById('export-start-date')?.value;
        const endDate = document.getElementById('export-end-date')?.value;
        
        console.log(`üìä Export date range: ${startDate} to ${endDate}`);
        
        // Prepare export data with PROPER date extraction
        const exportData = [];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        if (!dashboardData.customers) {
            throw new Error('No customer data available');
        }
        
        // Process each customer
        Object.values(dashboardData.customers).forEach(customer => {
            console.log(`üìä Processing customer: ${customer.name}`);
            
            if (customer.networks && customer.networks.length > 0) {
                customer.networks.forEach((network, networkIndex) => {
                    console.log(`  üìä Processing network: ${network.name}`);
                    
                    const rowData = {\n                        'Customer': customer.name || 'Unknown',\n                        'Network': network.name || network.network_name || `Network ${networkIndex + 1}`,\n                        'Country': customer.country || 'Unknown',\n                        'Node Qty': network.node_count || network.node_qty || network.nodes || 0,\n                        'NE Type': network.ne_type || network.platform || '1830 PSS',\n                        'GTAC': network.gtac || network.gateway || 'PSS',\n                        'Total Runs': network.runs || network.total_runs || 0,\n                        'Last Run Date': network.last_run_date || customer.last_run_date || 'Never'\n                    };\n                    \n                    // Extract dates for each month with MULTIPLE fallback methods\n                    months.forEach((month, monthIndex) => {\n                        let monthValue = '-';\n                        \n                        try {\n                            // METHOD 1: Direct months array\n                            if (network.months && Array.isArray(network.months) && network.months[monthIndex]) {\n                                monthValue = network.months[monthIndex];\n                                console.log(`    ‚úÖ Method 1 - ${month}: ${monthValue}`);\n                            }\n                            // METHOD 2: Monthly runs array  \n                            else if (network.monthly_runs && Array.isArray(network.monthly_runs) && network.monthly_runs[monthIndex]) {\n                                monthValue = network.monthly_runs[monthIndex];\n                                console.log(`    ‚úÖ Method 2 - ${month}: ${monthValue}`);\n                            }\n                            // METHOD 3: Network specific monthly data\n                            else if (customer.network_monthly_runs && customer.network_monthly_runs[network.name] && customer.network_monthly_runs[network.name][monthIndex + 1]) {\n                                monthValue = customer.network_monthly_runs[network.name][monthIndex + 1];\n                                console.log(`    ‚úÖ Method 3 - ${month}: ${monthValue}`);\n                            }\n                            // METHOD 4: Use dashboard table extraction\n                            else {\n                                const currentYear = new Date().getFullYear();\n                                const monthRunData = getNetworkMonthRunDates(customer, network.name, currentYear, monthIndex + 1);\n                                if (monthRunData && monthRunData.date && monthRunData.date !== '-') {\n                                    monthValue = monthRunData.date;\n                                    console.log(`    ‚úÖ Method 4 - ${month}: ${monthValue}`);\n                                }\n                            }\n                        } catch (error) {\n                            console.log(`    ‚ö†Ô∏è Error extracting ${month} for ${network.name}:`, error.message);\n                        }\n                        \n                        // Clean up the value\n                        if (monthValue && monthValue !== '-' && monthValue !== 'Never' && monthValue !== 'Not Run' && monthValue !== 'Not Started') {\n                            rowData[month] = monthValue;\n                        } else {\n                            rowData[month] = '-';\n                        }\n                    });\n                    \n                    exportData.push(rowData);\n                    console.log(`    üìä Added row for ${network.name} with dates`);\n                });\n            } else {\n                // Customer without networks\n                const rowData = {\n                    'Customer': customer.name || 'Unknown',\n                    'Network': 'No Networks',\n                    'Country': customer.country || 'Unknown',\n                    'Node Qty': customer.node_count || customer.nodes || 0,\n                    'NE Type': customer.ne_type || '1830 PSS',\n                    'GTAC': customer.gtac || 'PSS',\n                    'Total Runs': customer.runs || customer.total_runs || 0,\n                    'Last Run Date': customer.last_run_date || 'Never'\n                };\n                \n                // Add month data for customer level\n                months.forEach((month, monthIndex) => {\n                    let monthValue = '-';\n                    \n                    if (customer.months && customer.months[monthIndex]) {\n                        monthValue = customer.months[monthIndex];\n                    } else if (customer.monthly_runs && customer.monthly_runs[monthIndex]) {\n                        monthValue = customer.monthly_runs[monthIndex];\n                    }\n                    \n                    rowData[month] = monthValue !== '-' ? monthValue : '-';\n                });\n                \n                exportData.push(rowData);\n            }\n        });\n        \n        console.log(`üìä Prepared ${exportData.length} rows for export`);\n        \n        if (exportData.length === 0) {\n            throw new Error('No data to export');\n        }\n        \n        // Create form data for Excel API\n        const formData = new FormData();\n        formData.append('data', JSON.stringify(exportData));\n        formData.append('filename', `Customer_Health_Check_${new Date().toISOString().split('T')[0]}.xlsx`);\n        formData.append('csrfmiddlewaretoken', csrfToken);\n        \n        if (startDate) formData.append('start_date', startDate);\n        if (endDate) formData.append('end_date', endDate);\n        \n        console.log('üìä Sending data to Excel export API...');\n        \n        // Call export API\n        const response = await fetch('/api/customer-dashboard/export/', {\n            method: 'POST',\n            body: formData,\n            headers: {\n                'X-Requested-With': 'XMLHttpRequest'\n            }\n        });\n        \n        if (!response.ok) {\n            throw new Error(`Export API failed: ${response.status}`);\n        }\n        \n        // Download the file\n        const blob = await response.blob();\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `Customer_Dashboard_${new Date().toISOString().split('T')[0]}.xlsx`;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(a);\n        \n        console.log('‚úÖ Excel export completed with all dates!');\n        showNotification('‚úÖ Excel exported successfully with all dates!', 'success');\n        \n    } catch (error) {\n        console.error('‚ùå Export failed:', error);\n        showNotification(`‚ùå Export failed: ${error.message}`, 'error');\n    }\n};\n\n// üîÑ OVERRIDE ORIGINAL EXPORT FUNCTIONS\nwindow.exportToExcel = window.exportToExcelFixed;\nwindow.directExcelDownload = window.exportToExcelFixed;\n\nconsole.log('‚úÖ EXPORT DATES FIX LOADED!');\nconsole.log('üìä Now Excel export will include all monthly dates!');